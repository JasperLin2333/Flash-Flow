# ğŸ”„ å·¥ä½œæµç¼–æ’æœºåˆ¶è¯¦æƒ…

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° Flash Flow å·¥ä½œæµçš„åº•å±‚ç¼–æ’æœºåˆ¶ï¼ŒåŒ…æ‹¬ä¸Šä¸‹æ–‡ç®¡ç†ã€å˜é‡ç³»ç»Ÿã€æ‰§è¡Œå¼•æ“ã€åˆ†æ”¯æ§åˆ¶å’Œå®‰å…¨æœºåˆ¶ã€‚

---

## ğŸ“¦ FlowContext ä¸Šä¸‹æ–‡ç»“æ„

å·¥ä½œæµä½¿ç”¨ `FlowContext` ä½œä¸ºå…¨å±€ä¸Šä¸‹æ–‡ï¼Œé‡‡ç”¨**é”®å€¼å¯¹æ˜ å°„**å­˜å‚¨æ¯ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºæ•°æ®ï¼š

```typescript
// å®šä¹‰äº src/types/flow.ts

export interface FlowContextMeta {
  flowId?: string | null;   // å½“å‰å·¥ä½œæµ ID
  sessionId?: string;        // ä¼šè¯ IDï¼ˆç”¨äºå¯¹è¯è®°å¿†ï¼‰
  nodeLabels?: Record<string, string>;  // nodeId â†’ label æ˜ å°„
}

export interface FlowContext {
  [nodeId: string]: Record<string, unknown> | FlowContextMeta | undefined;
  _meta?: FlowContextMeta;  // å…ƒæ•°æ®ï¼ˆä»¥ _ å¼€å¤´ï¼‰
}
```

### ä¸Šä¸‹æ–‡ç¤ºä¾‹

```javascript
{
  "input_abc123": {
    "user_input": "å¸®æˆ‘å†™ä¸€ç¯‡æ–‡ç« ",
    "files": [],
    "formData": {}
  },
  "llm_def456": {
    "response": "è¿™æ˜¯ç”Ÿæˆçš„æ–‡ç« å†…å®¹..."
  },
  "tool_ghi789": {
    "formatted": "2025-12-15 12:00:00",
    "timestamp": 1734220800000,
    "timezone": "Asia/Shanghai"
  },
  "_meta": {
    "flowId": "flow_xyz",
    "sessionId": "session_123",
    "nodeLabels": {
      "input_abc123": "ç”¨æˆ·è¾“å…¥",
      "llm_def456": "æ–‡ç« ç”Ÿæˆ",
      "tool_ghi789": "è·å–å½“å‰æ—¶é—´"
    }
  }
}
```

### ä¸Šä¸‹æ–‡æ•°æ®è®¿é—®å·¥å…·

ç³»ç»Ÿæä¾›æ ‡å‡†åŒ–çš„ä¸Šä¸‹æ–‡è®¿é—®å‡½æ•°ï¼Œå®šä¹‰äº [contextUtils.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/executors/contextUtils.ts)ï¼š

| å‡½æ•° | åŠŸèƒ½ |
|------|------|
| `getUpstreamData(context)` | è·å–ç¬¬ä¸€ä¸ªä¸Šæ¸¸èŠ‚ç‚¹çš„è¾“å‡ºæ•°æ® |
| `getUpstreamEntries(context)` | è·å–æ‰€æœ‰ä¸Šæ¸¸èŠ‚ç‚¹çš„ `[nodeId, output]` æ•°ç»„ |
| `extractTextFromUpstream(data)` | æ™ºèƒ½æå–æ–‡æœ¬å†…å®¹ |
| `extractInputFromContext(context)` | ç»„åˆæå–è¾“å…¥æ–‡æœ¬ |
| `extractOutputFromContext(nodes, context)` | æå– Output èŠ‚ç‚¹çš„å®Œæ•´è¾“å‡ºï¼ˆå«é™„ä»¶ï¼‰ |

---

## ğŸ“Š èŠ‚ç‚¹è¾“å‡ºæ ‡å‡†æ ¼å¼

| èŠ‚ç‚¹ç±»å‹ | ä¸»è¦è¾“å‡ºå­—æ®µ | è¯´æ˜ |
|---------|-------------|------|
| **Input** | `user_input`, `files`, `formData` | ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ã€æ–‡ä»¶å’Œè¡¨å•æ•°æ® |
| **LLM** | `response` | AI ç”Ÿæˆçš„å›å¤å†…å®¹ï¼ˆæ”¯æŒæµå¼ï¼‰ |
| **RAG** | `query`, `documents`, `citations`, `documentCount` | æ£€ç´¢æŸ¥è¯¢åŠç»“æœ |
| **Tool** | å·¥å…·ç‰¹å®šå­—æ®µ | æ ¹æ®å·¥å…·ç±»å‹ä¸åŒï¼Œå¦‚ `formatted`, `results`, `content` ç­‰ |
| **Branch** | `conditionResult`, `passed`, + é€ä¼ æ•°æ® | æ¡ä»¶åˆ¤æ–­ç»“æœåŠä¸Šæ¸¸æ•°æ®é€ä¼  |
| **Output** | `text`, `attachments` | æœ€ç»ˆå±•ç¤ºæ–‡æœ¬å’Œé™„ä»¶åˆ—è¡¨ |

---

## ğŸ”— å˜é‡å¼•ç”¨æœºåˆ¶

### æ”¯æŒçš„å¼•ç”¨æ ¼å¼

| æ ¼å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `{{field_name}}` | ç›´æ¥ä½¿ç”¨å­—æ®µåï¼ˆåœ¨æ‰€æœ‰ä¸Šæ¸¸èŠ‚ç‚¹ä¸­æŸ¥æ‰¾ï¼‰ | `{{user_input}}`, `{{response}}` |
| `{{èŠ‚ç‚¹åç§°.field_name}}` | ä½¿ç”¨èŠ‚ç‚¹ label å‰ç¼€ï¼ˆ**æ¨è**ï¼Œæ›´æ˜ç¡®ï¼‰ | `{{è·å–å½“å‰æ—¶é—´.formatted}}` |
| `{{node_id.field_name}}` | ä½¿ç”¨èŠ‚ç‚¹ ID å‰ç¼€ | `{{tool_abc123.formatted}}` |

### å˜é‡æ”¶é›†æµç¨‹

å˜é‡æ”¶é›†ç”± [variableUtils.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/executors/utils/variableUtils.ts) ä¸­çš„ `collectVariables()` å‡½æ•°å®ç°ï¼š

```mermaid
flowchart TD
    A[å¼€å§‹æ”¶é›†å˜é‡] --> B{æ˜¯å¦è°ƒè¯•æ¨¡å¼?}
    B -->|æ˜¯| C[ä½¿ç”¨ Mock æ•°æ®]
    C --> Z[è¿”å›å˜é‡æ˜ å°„]
    B -->|å¦| D[éå†å…¨å±€ flowContext]
    D --> E[å±•å¼€èŠ‚ç‚¹è¾“å‡ºä¸ºå˜é‡<br/>è·³è¿‡ç›´æ¥ä¸Šæ¸¸]
    E --> F[éå†ç›´æ¥ä¸Šæ¸¸ context]
    F --> G[å±•å¼€ç›´æ¥ä¸Šæ¸¸è¾“å‡º<br/>è¦†ç›–åŒåå˜é‡]
    G --> H[æ·»åŠ è‡ªå®šä¹‰è¾“å‡ºå˜é‡]
    H --> Z
```

### å˜é‡æ”¶é›†ç®—æ³•

```typescript
function collectVariables(context, globalFlowContext, allNodes, mockData?) {
  const allVariables = {};
  
  // 1. è°ƒè¯•æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨ mock æ•°æ®
  if (mockData && Object.keys(mockData).length > 0) {
    Object.entries(mockData).forEach(([key, value]) => {
      allVariables[key] = String(value);
    });
    return allVariables;
  }
  
  // 2. å…ˆä»å…¨å±€ flowContext æå–ï¼ˆè¾ƒæ—©æ‰§è¡Œçš„èŠ‚ç‚¹ï¼‰
  for (const [nodeId, nodeOutput] of Object.entries(globalFlowContext)) {
    if (nodeId.startsWith('_')) continue;
    if (context[nodeId]) continue;  // è·³è¿‡ç›´æ¥ä¸Šæ¸¸ï¼ˆåé¢å¤„ç†ï¼‰
    
    const nodeLabel = findNodeLabel(nodeId, allNodes);
    flattenObject(nodeOutput, allVariables);            // {{fieldName}}
    flattenObject(nodeOutput, allVariables, nodeLabel); // {{èŠ‚ç‚¹åç§°.fieldName}}
    flattenObject(nodeOutput, allVariables, nodeId);    // {{nodeId.fieldName}}
    addCustomOutputs(nodeId, allVariables);
  }
  
  // 3. æœ€åä»ç›´æ¥ä¸Šæ¸¸ context æå–ï¼ˆä¼šè¦†ç›–å…¨å±€åŒåå˜é‡ï¼‰
  for (const [nodeId, nodeOutput] of Object.entries(context)) {
    if (nodeId.startsWith('_')) continue;
    
    flattenObject(nodeOutput, allVariables);            // ç›´æ¥ä¸Šæ¸¸ä¼˜å…ˆ
    flattenObject(nodeOutput, allVariables, nodeLabel);
    flattenObject(nodeOutput, allVariables, nodeId);
    addCustomOutputs(nodeId, allVariables);
  }
  
  return allVariables;
}
```

### å˜é‡ä¼˜å…ˆçº§

1. **ç›´æ¥ä¸Šæ¸¸** context ä¸­çš„èŠ‚ç‚¹è¾“å‡ºï¼ˆ**æœ€é«˜ä¼˜å…ˆçº§**ï¼‰
2. **å…¨å±€** flowContext ä¸­çš„èŠ‚ç‚¹è¾“å‡º

### å˜é‡æœªæ‰¾åˆ°æ—¶çš„å¤„ç†

- æ›¿æ¢ä¸º**ç©ºå­—ç¬¦ä¸²**
- æ§åˆ¶å°è¾“å‡ºè­¦å‘Šï¼š`[PromptParser] æœªæ‰¾åˆ°å˜é‡: xxxï¼Œå·²æ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²`

### flattenObject å±•å¼€è§„åˆ™

| æ•°æ®ç±»å‹ | å¤„ç†æ–¹å¼ |
|---------|---------|
| `null` / `undefined` | ç©ºå­—ç¬¦ä¸² `""` |
| åŸºç¡€ç±»å‹ | `String(value)` |
| åµŒå¥—å¯¹è±¡ | é€’å½’å±•å¼€ï¼Œå¦‚ `obj.a.b` â†’ `{{a.b}}` |
| æ•°ç»„ | `JSON.stringify(array)` |
| `_` å¼€å¤´çš„é”® | **è·³è¿‡**ï¼ˆå†…éƒ¨å­—æ®µï¼‰ |

---

## ğŸ“ æ–‡æœ¬æå–ä¼˜å…ˆçº§

`extractTextFromUpstream()` å‡½æ•°æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§æ™ºèƒ½æå–æ–‡æœ¬ï¼š

```typescript
const TEXT_FIELD_PRIORITY = ['text', 'response', 'user_input', 'query'];
```

### æå–æµç¨‹

```mermaid
flowchart LR
    A[è¾“å…¥æ•°æ®] --> B{æ•°æ®ç±»å‹?}
    B -->|string| C[ç›´æ¥è¿”å›]
    B -->|é object| D[String è½¬æ¢]
    B -->|object| E[æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾å­—æ®µ]
    E --> F{æ‰¾åˆ°éç©ºå­—æ®µ?}
    F -->|æ˜¯| G[è¿”å›å­—æ®µå€¼]
    F -->|å¦| H{æ˜¯ Branch è¾“å‡º?}
    H -->|æ˜¯| I[è¿‡æ»¤å…ƒæ•°æ®åå†æ¬¡æŸ¥æ‰¾]
    H -->|å¦| J[JSON stringify å…œåº•]
```

### Branch èŠ‚ç‚¹ç‰¹æ®Šå¤„ç†

```typescript
const BRANCH_METADATA_FIELDS = ['conditionResult', 'passed', 'value'];

// Branch è¾“å‡ºä¸­ä¼šè¿‡æ»¤è¿™äº›å…ƒæ•°æ®å­—æ®µåå†æå–æ–‡æœ¬
```

---

## âš¡ å¹¶è¡Œæ‰§è¡Œå¼•æ“

ç³»ç»Ÿä½¿ç”¨åŸºäº**æ‹“æ‰‘å±‚çº§**çš„å¹¶è¡Œæ‰§è¡Œå¼•æ“ï¼Œå®šä¹‰äº [executionActions.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/actions/executionActions.ts) å’Œ [parallelExecutionUtils.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/utils/parallelExecutionUtils.ts)ã€‚

### æ‰§è¡Œæµç¨‹æ¦‚è§ˆ

```mermaid
flowchart TD
    A[runFlow å¼€å§‹] --> B[å¾ªç¯ä¾èµ–æ£€æµ‹]
    B --> C{æœ‰å¾ªç¯?}
    C -->|æ˜¯| D[ä¸­æ­¢å¹¶æŠ¥é”™]
    C -->|å¦| E[è¾“å…¥éªŒè¯]
    E --> F{è¾“å…¥å®Œæ•´?}
    F -->|å¦| G[æ‰“å¼€è¾“å…¥å¯¹è¯æ¡†]
    F -->|æ˜¯| H[è·å–æ‰§è¡Œé”]
    H --> I{é”å†²çª?}
    I -->|æ˜¯| J[è­¦å‘Šå¹¶è¿”å›]
    I -->|å¦| K[é‡ç½®æ‰§è¡ŒçŠ¶æ€]
    K --> L[åˆå§‹åŒ–æµå¼æ¨¡å¼]
    L --> M[æ„å»º FlowContext]
    M --> N[è®¡ç®—æ‹“æ‰‘å±‚çº§]
    N --> O[æŒ‰å±‚çº§å¹¶è¡Œæ‰§è¡Œ]
    O --> P[é‡Šæ”¾æ‰§è¡Œé”]
    P --> Q[å®Œæˆ]
```

### æ‹“æ‰‘å±‚çº§è®¡ç®—

```typescript
// src/store/utils/parallelExecutionUtils.ts

function calculateTopologicalLevels(nodes, edges): Map<nodeId, level> {
  // Level 0 = å…¥å£èŠ‚ç‚¹ï¼ˆæ— ä¸Šæ¸¸ä¾èµ–ï¼‰
  // Level N = max(æ‰€æœ‰å‰ç½®èŠ‚ç‚¹å±‚çº§) + 1
  
  const calculateLevel = (nodeId) => {
    const incomers = getIncomers(node, nodes, edges);
    if (incomers.length === 0) return 0;  // å…¥å£èŠ‚ç‚¹
    
    let maxUpstreamLevel = -1;
    for (const incomer of incomers) {
      maxUpstreamLevel = Math.max(maxUpstreamLevel, calculateLevel(incomer.id));
    }
    return maxUpstreamLevel + 1;
  };
}
```

### å±‚çº§å¹¶è¡Œæ‰§è¡Œ

```mermaid
graph LR
    subgraph "Level 0"
        A[Input]
    end
    subgraph "Level 1"
        B[LLM-1]
        C[RAG]
    end
    subgraph "Level 2"
        D[Branch]
    end
    subgraph "Level 3"
        E[LLM-2]
        F[Tool]
    end
    subgraph "Level 4"
        G[Output]
    end
    A --> B
    A --> C
    B --> D
    C --> D
    D --> E
    D --> F
    E --> G
    F --> G
```

**æ‰§è¡Œè§„åˆ™**ï¼š
- åŒå±‚çº§èŠ‚ç‚¹**å¹¶è¡Œæ‰§è¡Œ**ï¼ˆ`Promise.allSettled`ï¼‰
- ç­‰å¾…å½“å‰å±‚çº§å…¨éƒ¨å®Œæˆåï¼Œæ‰æ‰§è¡Œä¸‹ä¸€å±‚çº§
- ä»»ä¸€èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥ä¼šè®°å½•é”™è¯¯å¹¶åœ¨å½“å‰å±‚çº§ç»“æŸåä¸­æ­¢

### æ‰§è¡Œé”æœºåˆ¶

```typescript
// é˜²æ­¢å¹¶å‘æ‰§è¡Œ
if (get()._executionLock) {
  console.warn('[RunFlow] æ‰§è¡Œå·²åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ');
  return;
}
set({ _executionLock: true });

try {
  // æ‰§è¡Œå·¥ä½œæµ...
} finally {
  set({ _executionLock: false });  // ç¡®ä¿é‡Šæ”¾é”
}
```

---

## ğŸŒ³ åˆ†æ”¯èŠ‚ç‚¹æ‰§è¡Œ

Branch èŠ‚ç‚¹ä½¿ç”¨**å®‰å…¨è¡¨è¾¾å¼æ±‚å€¼å™¨**ï¼Œè¯¦è§ [BranchNodeExecutor.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/executors/BranchNodeExecutor.ts)ã€‚

### æ”¯æŒçš„æ¡ä»¶è¡¨è¾¾å¼

| è¡¨è¾¾å¼ç±»å‹ | æ ¼å¼ | ç¤ºä¾‹ |
|-----------|------|------|
| **åŒ…å«åˆ¤æ–­** | `èŠ‚ç‚¹å.å­—æ®µ.includes('å…³é”®è¯')` | `LLM1.response.includes('æˆåŠŸ')` |
| **å‰ç¼€åˆ¤æ–­** | `èŠ‚ç‚¹å.å­—æ®µ.startsWith('å‰ç¼€')` | `Input.text.startsWith('æŸ¥è¯¢')` |
| **åç¼€åˆ¤æ–­** | `èŠ‚ç‚¹å.å­—æ®µ.endsWith('åç¼€')` | `Tool.result.endsWith('.pdf')` |
| **ç›¸ç­‰åˆ¤æ–­** | `èŠ‚ç‚¹å.å­—æ®µ === 'value'` | `Branch.status === 'active'` |
| **ä¸ç­‰åˆ¤æ–­** | `èŠ‚ç‚¹å.å­—æ®µ !== 'value'` | `LLM.type !== 'error'` |
| **æ•°å€¼æ¯”è¾ƒ** | `èŠ‚ç‚¹å.å­—æ®µ > æ•°å€¼` | `Score.value >= 60` |
| **é•¿åº¦æ¯”è¾ƒ** | `èŠ‚ç‚¹å.å­—æ®µ.length > æ•°å€¼` | `Input.text.length > 10` |

### å®‰å…¨æ±‚å€¼æœºåˆ¶

```typescript
// é¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ï¼ˆæ¨¡å—çº§åˆ«ï¼Œé¿å…é‡å¤åˆ›å»ºï¼‰
const INCLUDES_PATTERN = /^([...]).includes\(['"](.*)['"]\)$/;
const COMPARISON_PATTERN = /^([...])([>=<])(\d+)$/;

function safeEvaluateCondition(condition, context): boolean {
  // 1. æ„å»ºèŠ‚ç‚¹æŸ¥æ‰¾ Mapï¼ˆO(1) æŸ¥æ‰¾ï¼‰
  const lookupMap = buildNodeLookupMap(context);
  
  // 2. ç™½åå•æ¨¡å¼åŒ¹é…
  const includesMatch = condition.match(INCLUDES_PATTERN);
  if (includesMatch) {
    // å®‰å…¨æ‰§è¡Œ includes æ£€æŸ¥
    return value.includes(searchStr);
  }
  
  // 3. ä¸æ”¯æŒçš„è¡¨è¾¾å¼ â†’ è¿”å› false + è­¦å‘Š
  console.warn('Unsupported condition format:', condition);
  return false;
}
```

### åˆ†æ”¯è·¯å¾„æ§åˆ¶

```mermaid
graph TD
    A[ä¸Šæ¸¸èŠ‚ç‚¹] --> B[Branch]
    B -->|conditionResult=true| C[TRUE è·¯å¾„]
    B -->|conditionResult=false| D[FALSE è·¯å¾„]
    C --> E[ä¸‹æ¸¸èŠ‚ç‚¹ A]
    D --> F[ä¸‹æ¸¸èŠ‚ç‚¹ B]
    E --> G[æ±‡åˆèŠ‚ç‚¹]
    F --> G
```

**è·¯å¾„é˜»å¡æœºåˆ¶**ï¼š
1. Branch èŠ‚ç‚¹æ‰§è¡Œåè¿”å› `conditionResult: boolean`
2. æ ¹æ®ç»“æœç¡®å®šæœªé€‰ä¸­çš„ handleï¼ˆ`true` â†’ é˜»å¡ `false` è·¯å¾„ï¼‰
3. ä½¿ç”¨ `getDescendants()` è·å–æœªé€‰ä¸­è·¯å¾„çš„æ‰€æœ‰ä¸‹æ¸¸èŠ‚ç‚¹
4. å°†è¿™äº›èŠ‚ç‚¹åŠ å…¥ `blockedNodes` é›†åˆï¼Œåç»­å±‚çº§æ‰§è¡Œæ—¶è·³è¿‡

```typescript
if (node.type === 'branch' && result) {
  const conditionResult = !!result.conditionResult;
  const notTakenHandle = conditionResult ? 'false' : 'true';
  
  // è·å–å¹¶é˜»å¡æœªé€‰ä¸­åˆ†æ”¯çš„æ‰€æœ‰ä¸‹æ¸¸
  const blockedDescendants = getDescendants(nodeId, edges, notTakenHandle);
  blockedDescendants.forEach(id => blockedNodes.add(id));
}
```

---

## ğŸ”„ å¾ªç¯ä¾èµ–æ£€æµ‹

ç³»ç»Ÿä½¿ç”¨ DFS ç®—æ³•æ£€æµ‹ DAG ä¸­çš„å¾ªç¯ï¼Œå®šä¹‰äº [cycleDetection.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/utils/cycleDetection.ts)ã€‚

```typescript
function hasCycle(nodeId, nodes, edges, visited = new Set(), stack = new Set()): boolean {
  if (stack.has(nodeId)) return true;   // å½“å‰è·¯å¾„ä¸­å·²å­˜åœ¨ â†’ å¾ªç¯
  if (visited.has(nodeId)) return false; // å·²è®¿é—®è¿‡ä¸”æ— å¾ªç¯
  
  visited.add(nodeId);
  stack.add(nodeId);  // åŠ å…¥å½“å‰è·¯å¾„æ ˆ
  
  const outgoers = getOutgoers({ id: nodeId }, nodes, edges);
  for (const out of outgoers) {
    if (hasCycle(out.id, nodes, edges, visited, stack)) return true;
  }
  
  stack.delete(nodeId);  // å›æº¯æ—¶ç§»å‡ºè·¯å¾„æ ˆ
  return false;
}
```

**æ‰§è¡Œæ—¶æœº**ï¼šå·¥ä½œæµæ‰§è¡Œå‰ï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹è¿›è¡Œå¾ªç¯æ£€æµ‹ã€‚

---

## ğŸ” èŠ‚ç‚¹è§£æå·¥å…·

å®šä¹‰äº [sourceResolver.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/utils/sourceResolver.ts)ï¼Œæä¾›é«˜æ€§èƒ½çš„èŠ‚ç‚¹æŸ¥æ‰¾èƒ½åŠ›ã€‚

### èŠ‚ç‚¹ç´¢å¼•ç»“æ„

```typescript
interface NodeIndex {
  byId: Map<string, AppNode>;     // nodeId â†’ node
  byLabel: Map<string, AppNode>;  // label â†’ node
}

function buildNodeIndex(nodes): NodeIndex {
  // O(n) æ„å»ºï¼Œæ”¯æŒ O(1) æŸ¥æ‰¾
}
```

### å˜é‡å¼•ç”¨è§£æ

```typescript
function resolveSourceNodeId(value, nodes): string | null {
  // è¾“å…¥: "{{LLM1.response}}" æˆ– "{{èŠ‚ç‚¹å.å­—æ®µ}}"
  // è¾“å‡º: å¯¹åº”çš„ nodeId æˆ– null
  
  const match = value.match(/\{\{(.+?)\}\}/);
  const varPath = match[1];  // "LLM1.response"
  
  // å°è¯•åŒ¹é… "èŠ‚ç‚¹å.å­—æ®µ" æ ¼å¼
  const dotIndex = varPath.indexOf('.');
  if (dotIndex > 0) {
    const nodeLabel = varPath.substring(0, dotIndex);
    // å…ˆæŸ¥ labelï¼Œå†æŸ¥ id
  }
}
```

---

## ğŸ›¡ï¸ å®‰å…¨ä¸å®¹é”™æœºåˆ¶

### å‚æ•°éªŒè¯

| èŠ‚ç‚¹ç±»å‹ | éªŒè¯æœºåˆ¶ |
|---------|---------|
| **Input** | æ–‡æœ¬/æ–‡ä»¶/è¡¨å•å¿…å¡«é¡¹æ£€æŸ¥ |
| **RAG** | `files` æ•°ç»„éç©ºã€`fileSearchStoreName` å·²é…ç½® |
| **Tool** | Zod Schema äºŒæ¬¡éªŒè¯ |
| **Branch** | ç™½åå•è¡¨è¾¾å¼åŒ¹é…ï¼ˆéç™½åå•è¿”å› falseï¼‰ |
| **Output** | æ¨¡å¼ä¸é…ç½®ä¸€è‡´æ€§æ£€æŸ¥ |

### æ•æ„Ÿæ•°æ®è¿‡æ»¤

| åœºæ™¯ | è¿‡æ»¤è§„åˆ™ |
|------|---------|
| Branch é€ä¼  | è¿‡æ»¤ `_` å¼€å¤´å­—æ®µ |
| FlowContext è®¿é—® | è¿‡æ»¤ `_meta` ç­‰å†…éƒ¨å­—æ®µ |
| å˜é‡æ”¶é›† | è·³è¿‡ `_` å¼€å¤´çš„é”® |

### æ‰§è¡Œå®Œæ•´æ€§æ£€æŸ¥

```typescript
const checkFlowIntegrity = () => {
  const currentNodes = get().nodes;
  const currentIds = new Set(currentNodes.map(n => n.id));
  for (const id of initialNodeIds) {
    if (!currentIds.has(id)) {
      throw new Error("Execution interrupted: Flow structure changed");
    }
  }
};
```

---

## ğŸšï¸ æµå¼è¾“å‡ºæ¨¡å¼

Output èŠ‚ç‚¹æ”¯æŒå¤šç§æµå¼è¾“å‡ºæ¨¡å¼ï¼š

| æ¨¡å¼ | è¯´æ˜ | åˆå§‹åŒ–å‡½æ•° |
|------|------|-----------|
| `single` | å•æºç›´æ¥è¾“å‡º | é»˜è®¤ |
| `segmented` | åˆ†æ®µæµå¼ï¼ˆmerge æ¨¡å¼ï¼‰ | `initSegmentedStreaming(sourceIds)` |
| `select` | é¦–å­—é”å®šï¼ˆselect æ¨¡å¼ï¼‰ | `initSelectStreaming(sourceIds)` |

### Select æ¨¡å¼é¦–å­—é”å®š

```typescript
function tryLockSource(sourceId): boolean {
  if (lockedSourceId === null) {
    set({ lockedSourceId: sourceId });
    return true;  // æˆåŠŸé”å®š
  }
  return lockedSourceId === sourceId;  // å·²é”å®šåŒä¸€æº
}
```

---

## âš ï¸ å¸¸è§é”™è¯¯ä¸å¤„ç†

| é”™è¯¯åœºæ™¯ | é”™è¯¯ä¿¡æ¯ | é¢„é˜²æªæ–½ |
|---------|---------|---------|
| å¾ªç¯ä¾èµ– | `"æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–ï¼Œæ— æ³•æ‰§è¡Œå·¥ä½œæµ"` | æ‰§è¡Œå‰ DFS æ£€æµ‹ |
| å¹¶å‘æ‰§è¡Œ | æ§åˆ¶å°è­¦å‘Š | `_executionLock` æ‰§è¡Œé” |
| èŠ‚ç‚¹åˆ é™¤ | `"Execution interrupted: Flow structure changed"` | `checkFlowIntegrity()` æ£€æŸ¥ |
| éæ³•è¡¨è¾¾å¼ | æ§åˆ¶å°è­¦å‘Š + é»˜è®¤ false | ç™½åå•æ¨¡å¼åŒ¹é… |
| å˜é‡æœªæ‰¾åˆ° | æ›¿æ¢ä¸ºç©º + è­¦å‘Š | æ§åˆ¶å°æ—¥å¿— |

---

## ğŸ“ æ ¸å¿ƒä»£ç æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| [flow.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/types/flow.ts) | ç±»å‹å®šä¹‰ï¼ˆFlowContextã€èŠ‚ç‚¹æ•°æ®æ¥å£ï¼‰ |
| [executionActions.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/actions/executionActions.ts) | æ‰§è¡Œå¼•æ“ä¸»å…¥å£ |
| [parallelExecutionUtils.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/utils/parallelExecutionUtils.ts) | æ‹“æ‰‘å±‚çº§è®¡ç®—ã€å¹¶è¡Œæ‰§è¡Œå·¥å…· |
| [cycleDetection.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/utils/cycleDetection.ts) | å¾ªç¯ä¾èµ–æ£€æµ‹ |
| [variableUtils.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/executors/utils/variableUtils.ts) | å˜é‡æ”¶é›†ä¸å±•å¼€ |
| [contextUtils.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/executors/contextUtils.ts) | ä¸Šä¸‹æ–‡æ•°æ®è®¿é—®å·¥å…· |
| [sourceResolver.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/utils/sourceResolver.ts) | èŠ‚ç‚¹è§£æä¸ç´¢å¼• |
| [BranchNodeExecutor.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/executors/BranchNodeExecutor.ts) | åˆ†æ”¯èŠ‚ç‚¹æ‰§è¡Œå™¨ |
