# ğŸ“‹ Flash Flow èŠ‚ç‚¹åŠŸèƒ½ä¸å‚æ•°è¯¦æƒ…

> **æ›´æ–°æ—¶é—´**: 2025-12-08  
> **ç‰ˆæœ¬**: v3.0 (åŸºäºå®é™…ä»£ç å®ç°)

---

## ğŸ”¢ èŠ‚ç‚¹ç±»å‹æ€»è§ˆ

Flash Flow æ”¯æŒ 6 ç§èŠ‚ç‚¹ç±»å‹ï¼Œæ„æˆå®Œæ•´çš„å·¥ä½œæµç¼–æ’èƒ½åŠ›ï¼š

| èŠ‚ç‚¹ç±»å‹ | è‹±æ–‡ ID | åŠŸèƒ½æè¿° | å›¾æ ‡ |
|---------|--------|---------|------|
| è¾“å…¥èŠ‚ç‚¹ | `input` | å·¥ä½œæµå…¥å£ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥ | â¬‡ï¸ |
| LLM èŠ‚ç‚¹ | `llm` | è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆå†…å®¹ | ğŸ¤– |
| RAG èŠ‚ç‚¹ | `rag` | åŸºäºçŸ¥è¯†åº“çš„è¯­ä¹‰æ£€ç´¢ | ğŸ“š |
| å·¥å…·èŠ‚ç‚¹ | `tool` | è°ƒç”¨å¤–éƒ¨å·¥å…· API | ğŸ”§ |
| åˆ†æ”¯èŠ‚ç‚¹ | `branch` | æ¡ä»¶åˆ¤æ–­ä¸æµç¨‹åˆ†æ”¯ | ğŸ”€ |
| è¾“å‡ºèŠ‚ç‚¹ | `output` | å·¥ä½œæµç»ˆç‚¹ï¼Œå±•ç¤ºç»“æœ | â¬†ï¸ |

---

## 1ï¸âƒ£ Input èŠ‚ç‚¹ï¼ˆè¾“å…¥èŠ‚ç‚¹ï¼‰

### åŠŸèƒ½æè¿°
ç”¨æˆ·è¾“å…¥çš„å…¥å£èŠ‚ç‚¹ï¼Œæ”¯æŒ**æ–‡æœ¬è¾“å…¥**ã€**æ–‡ä»¶ä¸Šä¼ **ã€**ç»“æ„åŒ–è¡¨å•**ä¸‰ç§è¾“å…¥æ¨¡å¼ï¼Œå¯å•ç‹¬æˆ–ç»„åˆä½¿ç”¨ã€‚

### æ ¸å¿ƒå‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æè¿° |
|-------|------|-----|-------|------|
| `label` | string | âœ… | - | èŠ‚ç‚¹æ˜¾ç¤ºåç§° |
| `enableTextInput` | boolean | âŒ | `true` | å¯ç”¨æ–‡æœ¬è¾“å…¥æ¡† |
| `enableFileInput` | boolean | âŒ | `false` | å¯ç”¨æ–‡ä»¶ä¸Šä¼  |
| `enableStructuredForm` | boolean | âŒ | `false` | å¯ç”¨ç»“æ„åŒ–è¡¨å• |
| `text` | string | âŒ | `""` | ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹ |

### æ–‡ä»¶ä¸Šä¼ é…ç½® (`enableFileInput=true` æ—¶)

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|-------|------|-------|------|
| `fileConfig.allowedTypes` | string[] | - | å…è®¸çš„æ–‡ä»¶ç±»å‹ |
| `fileConfig.maxSizeMB` | number | `50` | å•æ–‡ä»¶æœ€å¤§ä½“ç§¯ (MB) |
| `fileConfig.maxCount` | number | `999` | æœ€å¤§æ–‡ä»¶æ•°é‡ |

**æ”¯æŒçš„æ–‡ä»¶ç±»å‹**:
- `image/*` - æ‰€æœ‰å›¾ç‰‡æ ¼å¼
- `.pdf`, `.doc`, `.docx` - æ–‡æ¡£
- `.xls`, `.xlsx` - è¡¨æ ¼
- `.ppt`, `.pptx` - æ¼”ç¤ºæ–‡ç¨¿
- `.txt`, `.md`, `.json`, `.csv` - æ–‡æœ¬

### ç»“æ„åŒ–è¡¨å•é…ç½® (`enableStructuredForm=true` æ—¶)

`formFields` æ•°ç»„ï¼Œæ¯ä¸ªå­—æ®µåŒ…å«ï¼š

| å­—æ®µç±»å‹ | type å€¼ | é¢å¤–å‚æ•° |
|---------|--------|---------|
| æ–‡æœ¬è¾“å…¥ | `"text"` | `placeholder`, `defaultValue` |
| å•é€‰ä¸‹æ‹‰ | `"select"` | `options`, `defaultValue` |
| å¤šé€‰ä¸‹æ‹‰ | `"multi-select"` | `options`, `defaultValue` (æ•°ç»„) |

**é€šç”¨å­—æ®µå‚æ•°**:
- `name`: å˜é‡åï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼ï¼š`field_xxxxxx`ï¼‰
- `label`: æ˜¾ç¤ºæ ‡ç­¾æ–‡æœ¬
- `required`: æ˜¯å¦å¿…å¡«

### æ‰§è¡Œé€»è¾‘ (InputNodeExecutor.ts)

```typescript
// æ ¸å¿ƒè¾“å‡ºæ„å»ºé€»è¾‘
const output: Record<string, unknown> = {
  user_input: inputData.text || "",      // ä¸»æ–‡æœ¬è¾“å…¥
  timestamp: new Date().toISOString(),   // ISO æ ¼å¼æ—¶é—´æˆ³
};

// æ–‡ä»¶é™„åŠ ï¼ˆå¦‚å¯ç”¨ï¼‰
if (inputData.files?.length > 0) {
  output.files = inputData.files;
}

// è¡¨å•æ•°æ®é™„åŠ ï¼ˆå¦‚å¯ç”¨ï¼‰- ä½œä¸ºåµŒå¥—å¯¹è±¡ä¿å­˜
if (inputData.formData && Object.keys(inputData.formData).length > 0) {
  output.formData = inputData.formData;
```

### è¾“å‡ºæ ¼å¼

```typescript
{
  user_input: string,                         // æ–‡æœ¬è¾“å…¥å†…å®¹
  timestamp: string,                          // è¾“å…¥æ—¶é—´æˆ³ (ISO æ ¼å¼)
  files?: { name: string; size: number; type: string; url?: string }[],  // ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
  formData?: Record<string, unknown>          // ç»“æ„åŒ–è¡¨å•æ•°æ®
}
```

### å˜é‡å¼•ç”¨æ–¹å¼

#### formDataï¼ˆç»“æ„åŒ–è¡¨å•ï¼‰
é€šè¿‡ `{{èŠ‚ç‚¹åç§°.formData.fieldName}}` å¼•ç”¨å…·ä½“å­—æ®µã€‚

#### filesï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰
æ”¯æŒæ‹†åˆ†å¼•ç”¨è®¿é—®æ¯ä¸ªæ–‡ä»¶çš„å±æ€§ï¼š

| å¼•ç”¨æ ¼å¼ | è¯´æ˜ |
|---------|------|
| `{{èŠ‚ç‚¹åç§°.files[0].name}}` | ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„æ–‡ä»¶å |
| `{{èŠ‚ç‚¹åç§°.files[0].type}}` | ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ MIME ç±»å‹ |
| `{{èŠ‚ç‚¹åç§°.files[0].size}}` | ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| `{{èŠ‚ç‚¹åç§°.files[0].url}}` | ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ URL |
| `{{èŠ‚ç‚¹åç§°.files[1].name}}` | ç¬¬äºŒä¸ªæ–‡ä»¶çš„æ–‡ä»¶å |

> [!NOTE]
> `formData` å’Œ `files` éƒ½æ˜¯åµŒå¥—ç»“æ„ï¼Œå­—æ®µ**ä¸ä¼š**è‡ªåŠ¨å±•å¼€ä¸ºé¡¶çº§å˜é‡ã€‚
> å¿…é¡»é€šè¿‡å®Œæ•´è·¯å¾„å¼•ç”¨ï¼Œå¦‚ `{{è¾“å…¥èŠ‚ç‚¹.formData.style}}` æˆ– `{{è¾“å…¥èŠ‚ç‚¹.files[0].url}}`ã€‚

---

## 2ï¸âƒ£ LLM èŠ‚ç‚¹ï¼ˆå¤§è¯­è¨€æ¨¡å‹èŠ‚ç‚¹ï¼‰

### åŠŸèƒ½æè¿°
è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆæ–‡æœ¬å†…å®¹ï¼Œæ”¯æŒ**å˜é‡å¼•ç”¨**ã€**å¯¹è¯è®°å¿†**å’Œ**æµå¼è¾“å‡º**ã€‚

### æ ¸å¿ƒå‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æè¿° |
|-------|------|-----|-------|------|
| `label` | string | âœ… | - | èŠ‚ç‚¹æ˜¾ç¤ºåç§° |
| `model` | string | âŒ | `"doubao-seed-1-6-flash-250828"` | æ¨¡å‹é€‰æ‹© |
| `systemPrompt` | string | âŒ | `""` | ç³»ç»Ÿæç¤ºè¯ï¼Œæ”¯æŒ `{{variable}}` è¯­æ³• |
| `temperature` | number | âŒ | `0.7` | ç”Ÿæˆæ¸©åº¦ (0.0-1.0) |
| `enableMemory` | boolean | âŒ | `false` | å¯ç”¨å¯¹è¯è®°å¿† |
| `memoryMaxTurns` | number | âŒ | `10` | æœ€å¤§è®°å¿†è½®æ•° (1-20) |

### Temperature å‚æ•°è¯´æ˜

| å€¼èŒƒå›´ | æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|-------|------|---------|
| 0.0-0.3 | ç¡®å®šæ€§è¾“å‡º | ç¿»è¯‘ã€æ‘˜è¦ã€é—®ç­” |
| 0.4-0.6 | å¹³è¡¡æ¨¡å¼ | é€šç”¨å¯¹è¯ |
| 0.7-1.0 | åˆ›é€ æ€§è¾“å‡º | åˆ›ä½œã€å¤´è„‘é£æš´ |

### éœ€è¦çš„ä¸Šæ¸¸è¾“å…¥ (inputMappings)

| å­—æ®µå | æè¿° | å¿…å¡« |
|-------|------|-----|
| `user_input` | ç”¨æˆ·æ¶ˆæ¯å†…å®¹ | âœ… |

### æ‰§è¡Œé€»è¾‘ (LLMNodeExecutor.ts)

```typescript
// 1. å˜é‡æ”¶é›†ä¸æ›¿æ¢
const allVariables = collectVariables(context, globalFlowContext, allNodes);
systemPrompt = replaceVariables(systemPrompt, allVariables);

// 2. è¾“å…¥å†…å®¹è§£æ (ä»ä¸Šæ¸¸ context ä¸­æå– user_input)
const inputContent = resolveInputContent(context, ...);

// 3. å¯¹è¯è®°å¿†å¤„ç†ï¼ˆå¦‚å¯ç”¨ï¼‰
if (memoryEnabled && flowId && sessionId) {
  conversationHistory = await fetchMemory(flowId, memoryNodeId, sessionId, maxTurns, inputContent);
}

// 4. æµå¼è¯·æ±‚åˆ° /api/run-node-stream
const resp = await fetch("/api/run-node-stream", {
  method: "POST",
  body: JSON.stringify({
    model: llmData.model,
    systemPrompt,
    temperature: llmData.temperature,
    input: inputContent,
    conversationHistory: memoryEnabled ? conversationHistory : undefined,
  }),
});
```

**è¾“å…¥è§£æé€»è¾‘ (`resolveInputContent`)**:
1. è°ƒè¯•æ¨¡å¼ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ª mock å€¼
2. æ­£å¸¸æ¨¡å¼ï¼šéå†ä¸Šæ¸¸ contextï¼ŒæŸ¥æ‰¾åŒ…å« `user_input` å­—æ®µçš„èŠ‚ç‚¹è¾“å‡º

```typescript
// ä»ä¸Šæ¸¸ context ä¸­è·å– user_input
for (const [, data] of upstreamEntries) {
  if (data && typeof data === 'object') {
    const obj = data as Record<string, unknown>;
    if (typeof obj.user_input === 'string' && obj.user_input.trim()) {
      return obj.user_input;
    }
  }
}
```

### ç”¨æˆ·äº¤äº’èŠ‚ç‚¹åˆ¤å®š

```typescript
function checkIsUserFacingLLM(nodeId, nodes, edges): boolean {
  // æ¡ä»¶ 1: ç›´æ¥è¿æ¥åˆ° output èŠ‚ç‚¹
  for (const edge of outgoingEdges) {
    if (targetNode?.type === 'output') return true;
  }
  
  // æ¡ä»¶ 2: ä» branch èŠ‚ç‚¹æ¥æ”¶è¾“å…¥
  for (const inEdge of incomingEdges) {
    if (sourceNode?.type === 'branch') return true;
  }
  
  return false;
}
```

### å¯¹è¯è®°å¿†æœºåˆ¶

**è®°å¿†é”®åˆ†é…è§„åˆ™**:
- **ç”¨æˆ·äº¤äº’ LLM** â†’ å…±äº«é”® `"__main__"`
- **ä¸­é—´å¤„ç† LLM** â†’ èŠ‚ç‚¹ç‹¬ç«‹é”® (`node.id`)

```typescript
const memoryNodeId = isUserFacingLLM ? "__main__" : node.id;
```

**å­˜å‚¨æ¶æ„**:
- æœåŠ¡: `llmMemoryService`
- æ”¯æŒè·¨ä¼šè¯æŒä¹…åŒ–
- è‡ªåŠ¨è£å‰ªè¶…è¿‡ `memoryMaxTurns` çš„æ—§æ¶ˆæ¯

**æµå¼è¾“å‡º**:
- ä»…ç”¨æˆ·äº¤äº’ LLM èŠ‚ç‚¹å¯ç”¨
- ä½¿ç”¨ Server-Sent Events (SSE) å®æ—¶è¿”å›
- æ¯ chunk å»¶è¿Ÿ 30msï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰

### è¾“å‡ºæ ¼å¼

```typescript
{
  response: string  // LLM ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹
}
```

---

## 3ï¸âƒ£ RAG èŠ‚ç‚¹ï¼ˆæ£€ç´¢å¢å¼ºç”ŸæˆèŠ‚ç‚¹ï¼‰

### åŠŸèƒ½æè¿°
æ”¯æŒä¸¤ç§æ¨¡å¼çš„æ–‡æ¡£æ£€ç´¢ï¼š
1. **é™æ€æ¨¡å¼**ï¼šåŸºäº Builder é¢„ä¸Šä¼ çš„çŸ¥è¯†åº“æ–‡ä»¶ï¼Œä½¿ç”¨ Gemini File Search API
2. **åŠ¨æ€æ¨¡å¼**ï¼šä»ä¸Šæ¸¸ Input èŠ‚ç‚¹å¼•ç”¨ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼Œä½¿ç”¨ Gemini å¤šæ¨¡æ€ APIï¼ˆç§’çº§å“åº”ï¼‰

### æ ¸å¿ƒå‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æè¿° |
|-------|------|-----|-------|------|
| `label` | string | âœ… | - | èŠ‚ç‚¹æ˜¾ç¤ºåç§° |
| `files` | File[] | âŒ | `[]` | çŸ¥è¯†åº“æ–‡ä»¶åˆ—è¡¨ï¼ˆé™æ€æ¨¡å¼ï¼‰ |
| `topK` | number | âŒ | `5` | æ£€ç´¢ç»“æœæ•° (1/3/5/7/10) |
| `maxTokensPerChunk` | number | âŒ | `200` | åˆ†å—å¤§å° (50-500) |
| `maxOverlapTokens` | number | âŒ | `20` | é‡å  Token æ•° (0-100) |

**æ”¯æŒçš„æ–‡ä»¶æ ¼å¼**: `.pdf`, `.txt`, `.md`, `.doc`, `.docx`, å›¾ç‰‡æ ¼å¼ï¼ˆåŠ¨æ€æ¨¡å¼ï¼‰  
**å•æ–‡ä»¶æœ€å¤§**: 100MB

### ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µï¼ˆé™æ€æ¨¡å¼ï¼‰

| å­—æ®µå | æè¿° |
|-------|------|
| `fileSearchStoreName` | Gemini Store èµ„æºåç§° |
| `fileSearchStoreId` | Store æ˜¾ç¤º ID |
| `uploadStatus` | ä¸Šä¼ çŠ¶æ€ï¼š`idle` / `uploading` / `processing` / `completed` / `error` |
| `uploadError` | é”™è¯¯è¯¦æƒ…ï¼ˆå¤±è´¥æ—¶ï¼‰ |

### éœ€è¦çš„ä¸Šæ¸¸è¾“å…¥ (inputMappings)

| å­—æ®µå | æè¿° | å¿…å¡« |
|-------|------|-----|
| `query` | æ£€ç´¢æŸ¥è¯¢æ–‡æœ¬ | âœ… |
| `files` | åŠ¨æ€æ–‡ä»¶å¼•ç”¨ï¼ˆå¦‚ `{{è¾“å…¥èŠ‚ç‚¹.files}}`ï¼‰ | âŒ |

### æ‰§è¡Œé€»è¾‘ (RAGNodeExecutor.ts)

```typescript
// 1. è§£æ inputMappings
const inputMappings = ragData.inputMappings;

// 2. è§£ææŸ¥è¯¢å†…å®¹ï¼ˆä¼˜å…ˆä½¿ç”¨ inputMappings.queryï¼‰
const query = this.resolveQuery(inputMappings?.query, context);

// 3. æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨æ€æ–‡ä»¶å¼•ç”¨
const dynamicFiles = this.resolveDynamicFiles(inputMappings?.files, context);

if (dynamicFiles && dynamicFiles.length > 0) {
  // åŠ¨æ€æ¨¡å¼ï¼šä½¿ç”¨å¤šæ¨¡æ€ API ç›´æ¥å¤„ç†æ–‡ä»¶
  return await this.executeWithMultimodal(query, dynamicFiles);
  // è°ƒç”¨ geminiFileSearchAPI.queryWithFiles()
} else {
  // é™æ€æ¨¡å¼ï¼šä½¿ç”¨ File Search Store
  return await this.executeWithFileSearch(query, ragData);
  // è°ƒç”¨ geminiFileSearchAPI.searchInStore()
}
```

**åŠ¨æ€æ–‡ä»¶è§£æ** (`resolveDynamicFiles`):
1. è§£æ `{{èŠ‚ç‚¹åç§°.files}}` å˜é‡æ¨¡æ¿
2. è¿‡æ»¤å‡ºåŒ…å« `url` å±æ€§çš„æœ‰æ•ˆæ–‡ä»¶å¯¹è±¡
3. è¿”å› `{ name, url, type }` æ•°ç»„

**å˜é‡è§£æä¼˜å…ˆçº§**:
1. `nodeId.fieldName` - æŒ‰èŠ‚ç‚¹ ID æŸ¥æ‰¾
2. `nodeLabel.fieldName` - æŒ‰èŠ‚ç‚¹æ ‡ç­¾æŸ¥æ‰¾ï¼ˆé€šè¿‡ `context._meta.nodeLabels`ï¼‰
3. `fieldName` - åœ¨æ‰€æœ‰ä¸Šæ¸¸èŠ‚ç‚¹ä¸­æŸ¥æ‰¾è¯¥å­—æ®µ

### è¾“å‡ºæ ¼å¼

```typescript
{
  query: string,           // æ£€ç´¢æŸ¥è¯¢æ–‡æœ¬
  documents: string[],     // æ£€ç´¢åˆ°çš„æ–‡æ¡£ç‰‡æ®µ/LLMå›ç­”
  citations: any[],        // å¼•ç”¨ä¿¡æ¯
  documentCount: number,   // æ–‡æ¡£æ•°é‡
  mode: 'multimodal' | 'fileSearch'  // æ‰§è¡Œæ¨¡å¼
}
```

> [!TIP]
> **åœºæ™¯é€‰æ‹©**ï¼š
> - ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶å¹¶æé—® â†’ ä½¿ç”¨åŠ¨æ€æ¨¡å¼ï¼Œé…ç½® `inputMappings.files`
> - å›ºå®šçŸ¥è¯†åº“é—®ç­” â†’ ä½¿ç”¨é™æ€æ¨¡å¼ï¼Œåœ¨ Builder é¢„ä¸Šä¼ æ–‡ä»¶

---

## 4ï¸âƒ£ Tool èŠ‚ç‚¹ï¼ˆå·¥å…·èŠ‚ç‚¹ï¼‰

### åŠŸèƒ½æè¿°
è°ƒç”¨å¤–éƒ¨å·¥å…· API æ‰§è¡Œä¸“é¡¹ä»»åŠ¡ï¼Œæ”¯æŒå‚æ•°éªŒè¯å’Œå˜é‡å¼•ç”¨ã€‚

### æ ¸å¿ƒå‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æè¿° |
|-------|------|-----|-------|------|
| `label` | string | âœ… | - | èŠ‚ç‚¹æ˜¾ç¤ºåç§° |
| `toolType` | string | âœ… | `"web_search"` | å·¥å…·ç±»å‹ |
| `inputs` | object | âŒ | `{}` | å·¥å…·è¾“å…¥å‚æ•°ï¼ˆæ”¯æŒå˜é‡å¼•ç”¨ï¼‰ |

### æ‰§è¡Œé€»è¾‘ (ToolNodeExecutor.ts)

```typescript
// 1. æ”¶é›†æ‰€æœ‰ä¸Šæ¸¸å˜é‡
const allVariables: Record<string, string> = {};

// é€’å½’å±•å¼€å¯¹è±¡ï¼Œç”Ÿæˆå¤šç§å¼•ç”¨æ ¼å¼
const flattenObject = (obj, prefix = "") => {
  for (const [key, value] of Object.entries(obj)) {
    const newKey = prefix ? `${prefix}.${key}` : key;
    if (typeof value === 'object' && !Array.isArray(value)) {
      flattenObject(value, newKey);  // é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡
    } else if (Array.isArray(value)) {
      allVariables[newKey] = JSON.stringify(value);
    } else {
      allVariables[newKey] = String(value);
    }
  }
};

// ä»ç›´æ¥ä¸Šæ¸¸ context æå–
for (const [nodeId, nodeOutput] of Object.entries(context)) {
  flattenObject(nodeOutput);           // æ— å‰ç¼€: {{fieldName}}
  flattenObject(nodeOutput, nodeLabel); // æ ‡ç­¾å‰ç¼€: {{èŠ‚ç‚¹åç§°.fieldName}}
  flattenObject(nodeOutput, nodeId);    // IDå‰ç¼€: {{node_xxx.fieldName}}
  
  // æ·»åŠ è‡ªå®šä¹‰è¾“å‡ºå˜é‡
  if (customOutputs) {
    customOutputs.forEach(cv => {
      allVariables[cv.name] = cv.value;
      allVariables[`${nodeLabel}.${cv.name}`] = cv.value;
    });
  }
}

// 2. æ›¿æ¢ inputs ä¸­çš„å˜é‡
const replacedInputs = {};
for (const [key, value] of Object.entries(inputs)) {
  if (typeof value === 'string') {
    replacedInputs[key] = replaceVariables(value, allVariables, false);
  } else {
    replacedInputs[key] = value;
  }
}

// 3. Zod Schema éªŒè¯
const validation = validateToolInputs(toolType, replacedInputs);
if (!validation.success) {
  throw new Error(`å‚æ•°éªŒè¯å¤±è´¥: ${validation.error}`);
}

// 4. æ‰§è¡Œå·¥å…·
const result = await executeToolAction({ toolType, inputs: replacedInputs });
```

### å¯ç”¨å·¥å…·ç±»å‹

---

#### ğŸ” web_searchï¼ˆç½‘é¡µæœç´¢ï¼‰

**æè¿°**: ä½¿ç”¨ Tavily æœç´¢å¼•æ“è”ç½‘æŸ¥æ‰¾ç›¸å…³ä¿¡æ¯

| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æè¿° |
|-----|------|-----|-------|------|
| `query` | string | âœ… | - | æœç´¢æŸ¥è¯¢å†…å®¹ |
| `maxResults` | number | âŒ | `5` | æœ€å¤§è¿”å›ç»“æœæ•° (1-10) |

**è¾“å‡º**:
```json
{
  "results": [{"title": "...", "url": "...", "snippet": "..."}],
  "count": 5
}
```

---

#### ğŸ§® calculatorï¼ˆè®¡ç®—å™¨ï¼‰

**æè¿°**: å®‰å…¨è®¡ç®—æ•°å­¦è¡¨è¾¾å¼

| å‚æ•° | ç±»å‹ | å¿…å¡« | æè¿° |
|-----|------|-----|------|
| `expression` | string | âœ… | æ•°å­¦è¡¨è¾¾å¼ï¼Œå¦‚ `"2 + 2 * 3"` |

**è¾“å‡º**:
```json
{
  "expression": "2 + 2 * 3",
  "result": 8
}
```

---

#### ğŸ• datetimeï¼ˆæ—¥æœŸæ—¶é—´ï¼‰

**æè¿°**: è·å–å½“å‰æ—¶é—´ã€æ—¥æœŸæ ¼å¼åŒ–ã€æ—¥æœŸè®¡ç®—

| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æè¿° |
|-----|------|-----|-------|------|
| `operation` | enum | âŒ | `"now"` | æ“ä½œç±»å‹ï¼š`now`/`format`/`diff`/`add` |
| `date` | string | âŒ | å½“å‰æ—¶é—´ | è¾“å…¥æ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ |
| `targetDate` | string | âŒ | - | ç›®æ ‡æ—¥æœŸï¼ˆç”¨äº `diff` æ“ä½œï¼‰ |
| `format` | string | âŒ | `"YYYY-MM-DD HH:mm:ss"` | è¾“å‡ºæ ¼å¼ |
| `amount` | number | âŒ | - | å¢å‡æ•°é‡ï¼ˆç”¨äº `add` æ“ä½œï¼‰ |
| `unit` | enum | âŒ | - | æ—¶é—´å•ä½ï¼š`year`/`month`/`day`/`hour`/`minute`/`second` |

**è¾“å‡ºç¤ºä¾‹**:
```json
// now æ“ä½œ
{ "formatted": "2025-12-07 11:15:00", "timestamp": 1733547300000, "timezone": "Asia/Shanghai" }

// diff æ“ä½œ
{ "from": "2025-01-01", "to": "2025-12-31", "difference": { "days": 364 }, "humanReadable": "364 å¤©" }
```

---

#### â›… weatherï¼ˆå¤©æ°”æŸ¥è¯¢ï¼‰

**æè¿°**: å®æ—¶æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯ï¼ˆä½¿ç”¨å’Œé£å¤©æ°” APIï¼‰

| å‚æ•° | ç±»å‹ | å¿…å¡« | æè¿° |
|-----|------|-----|------|
| `city` | string | âœ… | åŸå¸‚åç§°ï¼Œå¦‚ `"åŒ—äº¬"`ã€`"ä¸Šæµ·"` |

**è¾“å‡º**:
```json
{
  "city": "åŒ—äº¬",
  "weather": { "text": "æ™´", "temp": "5Â°C", "humidity": "30%" },
  "summary": "åŒ—äº¬å½“å‰å¤©æ°”: æ™´ï¼Œæ¸©åº¦ 5Â°Cï¼Œæ¹¿åº¦ 30%"
}
```

> [!IMPORTANT]
> éœ€è¦é…ç½®ç¯å¢ƒå˜é‡ `QWEATHER_API_KEY`

---

#### ğŸŒ url_readerï¼ˆç½‘é¡µè¯»å–ï¼‰

**æè¿°**: æå–å¹¶è§£æç½‘é¡µçš„æ­£æ–‡å†…å®¹

| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æè¿° |
|-----|------|-----|-------|------|
| `url` | string | âœ… | - | è¦è¯»å–çš„ç½‘é¡µ URL |
| `maxLength` | number | âŒ | `5000` | æœ€å¤§è¿”å›å­—ç¬¦æ•° (100-50000) |

**è¾“å‡º**:
```json
{
  "url": "https://example.com",
  "title": "é¡µé¢æ ‡é¢˜",
  "content": "æå–çš„æ­£æ–‡å†…å®¹...",
  "contentLength": 3500,
  "truncated": false
}
```

---

### å‚æ•°éªŒè¯æœºåˆ¶

1. **è°ƒè¯•æ¨¡å¼**: UI å±‚å®æ—¶éªŒè¯ï¼ˆToolDebugDialogï¼‰
2. **æ­£å¼æ‰§è¡Œ**: æ‰§è¡Œå™¨äºŒæ¬¡éªŒè¯ï¼ˆToolNodeExecutorï¼‰
3. **éªŒè¯å·¥å…·**: ä½¿ç”¨ Zod Schema ç¡®ä¿ç±»å‹å®‰å…¨

### å˜é‡å¼•ç”¨æ”¯æŒ

Tool èŠ‚ç‚¹çš„ `inputs` å‚æ•°æ”¯æŒ `{{variable}}` è¯­æ³•å¼•ç”¨ä¸Šæ¸¸æ•°æ®ï¼š

```
// ç¤ºä¾‹ï¼šåœ¨ query å‚æ•°ä¸­å¼•ç”¨æ—¶é—´å·¥å…·çš„è¾“å‡º
ä»Šæ—¥å¤©æ°” {{è·å–å½“å‰æ—¶é—´.formatted}}
```

---

## 5ï¸âƒ£ Branch èŠ‚ç‚¹ï¼ˆåˆ†æ”¯èŠ‚ç‚¹ï¼‰

### åŠŸèƒ½æè¿°
åŸºäºæ¡ä»¶è¡¨è¾¾å¼æ§åˆ¶æµç¨‹åˆ†æ”¯èµ°å‘ï¼Œæ”¯æŒ**å®‰å…¨è¡¨è¾¾å¼æ±‚å€¼**ï¼Œé˜²æ­¢ä»£ç æ³¨å…¥æ”»å‡»ã€‚

### æ ¸å¿ƒå‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æè¿° |
|-------|------|-----|-------|------|
| `label` | string | âœ… | - | èŠ‚ç‚¹æ˜¾ç¤ºåç§° |
| `condition` | string | âŒ | `""` | åˆ¤æ–­æ¡ä»¶ï¼ˆå®‰å…¨è¡¨è¾¾å¼ï¼‰ |

### éœ€è¦çš„ä¸Šæ¸¸è¾“å…¥

> [!NOTE]
> Branch èŠ‚ç‚¹**ä¸éœ€è¦**æ˜¾å¼é…ç½® `input` å­—æ®µã€‚æ¡ä»¶è¡¨è¾¾å¼ä½¿ç”¨ `èŠ‚ç‚¹åç§°.å­—æ®µå` æ ¼å¼ç›´æ¥å¼•ç”¨ä¸Šæ¸¸æ•°æ®ã€‚

### æ‰§è¡Œé€»è¾‘ (BranchNodeExecutor.ts)

```typescript
// 1. è·å–ä¸Šæ¸¸æ•°æ®ï¼ˆè¿‡æ»¤ _meta ç­‰å†…éƒ¨å­—æ®µï¼‰
const upstreamData = getUpstreamData(context);

// 2. æ¡ä»¶ä¸ºç©ºæ—¶é»˜è®¤è¿”å› true
if (!condition || !condition.trim()) {
  return {
    passed: true,
    conditionResult: true,
    ...upstreamData
  };
}

// 3. å®‰å…¨è¡¨è¾¾å¼æ±‚å€¼
const conditionResult = safeEvaluateCondition(condition, context);

// 4. é€ä¼ ä¸Šæ¸¸æ•°æ®ï¼ˆè¿‡æ»¤æ•æ„Ÿå­—æ®µï¼‰
const filteredData = Object.fromEntries(
  Object.entries(upstreamData).filter(([key]) => !key.startsWith('_'))
);

return {
  passed: true,
  conditionResult,
  ...filteredData
};
```

### å®‰å…¨è¡¨è¾¾å¼æ±‚å€¼å™¨ (safeEvaluateCondition)

**æ ¸å¿ƒæœºåˆ¶**: ä½¿ç”¨æ­£åˆ™åŒ¹é…ç™½åå•æ¨¡å¼ï¼Œåªå…è®¸ç‰¹å®šæ“ä½œï¼Œé˜²æ­¢ä»£ç æ³¨å…¥ã€‚

**èŠ‚ç‚¹æŸ¥æ‰¾é€»è¾‘**:
```typescript
const extractNodeAndPath = (expr) => {
  // 1. åŒ¹é… nodeName.path æ ¼å¼ï¼ˆæ”¯æŒä¸­è‹±æ–‡èŠ‚ç‚¹åï¼‰
  const match = expr.match(/^([a-zA-Z\u4e00-\u9fa5_][\w\u4e00-\u9fa5]*)\.([\w.]+)/);
  
  // 2. åœ¨ context ä¸­æŒ‰ nodeId æŸ¥æ‰¾
  for (const [nodeId, nodeOutput] of Object.entries(context)) {
    if (nodeId === nodeName) return { nodeData: nodeOutput, path };
  }
  
  // 3. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä» _meta.nodeLabels ä¸­æŒ‰ label æŸ¥æ‰¾
  if (meta?.nodeLabels) {
    for (const [nodeId, label] of Object.entries(meta.nodeLabels)) {
      if (label === nodeName) return { nodeData: context[nodeId], path };
    }
  }
};
```

### æ”¯æŒçš„è¡¨è¾¾å¼æ ¼å¼ï¼ˆç™½åå•æ¨¡å¼ï¼‰

#### 1. å­—ç¬¦ä¸²æ–¹æ³•

```javascript
ç”¨æˆ·è¾“å…¥.user_input.includes('å…³é”®è¯')
LLMå¤„ç†.response.startsWith('å‰ç¼€')
èŠ‚ç‚¹åç§°.text.endsWith('åç¼€')
```

#### 2. æ•°å€¼æ¯”è¾ƒ

```javascript
è®¡ç®—èŠ‚ç‚¹.result > 60
input_1.value >= 100
tool_abc123.count < 10
èŠ‚ç‚¹åç§°.amount <= 50
```

#### 3. ç­‰å€¼åˆ¤æ–­

```javascript
ç”¨æˆ·è¾“å…¥.user_input === 'hello'
RAGæ£€ç´¢.documentCount !== 0
å¼€å…³èŠ‚ç‚¹.enabled === true
çŠ¶æ€èŠ‚ç‚¹.status === false
```

#### 4. å±æ€§è®¿é—® (åµŒå¥—è·¯å¾„æ”¯æŒ)

```javascript
ç”¨æˆ·è¾“å…¥.user_input.length > 5
LLMå›å¤.response.data.status === 'success'
```

**åµŒå¥—å€¼è·å–**:
```typescript
function getNestedValue(obj, path) {
  const parts = path.split('.');
  let current = obj;
  for (const part of parts) {
    if (current === null || current === undefined) return undefined;
    current = current[part];
  }
  return current;
}
```

### è¾“å‡ºå¥æŸ„

- **TRUE å¥æŸ„**ï¼ˆç»¿è‰²ï¼‰: æ¡ä»¶ä¸º `true` æ—¶æ‰§è¡Œä¸‹æ¸¸
- **FALSE å¥æŸ„**ï¼ˆçº¢è‰²ï¼‰: æ¡ä»¶ä¸º `false` æ—¶æ‰§è¡Œä¸‹æ¸¸

### è¾“å‡ºæ ¼å¼

```typescript
{
  passed: true,              // å›ºå®šä¸º trueï¼ˆè¡¨ç¤ºèŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸï¼‰
  conditionResult: boolean,  // æ¡ä»¶åˆ¤æ–­ç»“æœ
  ...upstreamData           // è¿‡æ»¤åçš„ä¸Šæ¸¸æ•°æ®é€ä¼ 
}
```

> [!CAUTION]
> ä¸æ”¯æŒçš„è¡¨è¾¾å¼æ ¼å¼ä¼šè§¦å‘è­¦å‘Šå¹¶é»˜è®¤è¿”å› `false`ï¼Œè¯·ä¸¥æ ¼éµå¾ªç™½åå•è¯­æ³•ã€‚

---

## 6ï¸âƒ£ Output èŠ‚ç‚¹ï¼ˆè¾“å‡ºèŠ‚ç‚¹ï¼‰

### åŠŸèƒ½æè¿°
å·¥ä½œæµçš„ç»ˆç‚¹èŠ‚ç‚¹ï¼Œè´Ÿè´£ä»ä¸Šæ¸¸èŠ‚ç‚¹æå–æœ€ç»ˆè¾“å‡ºæ–‡æœ¬å¹¶å±•ç¤ºã€‚æ”¯æŒ**å››ç§è¾“å‡ºæ¨¡å¼**ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚ã€‚

### æ ¸å¿ƒå‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æè¿° |
|-------|------|-----|-------|------|
| `label` | string | âœ… | - | èŠ‚ç‚¹æ˜¾ç¤ºåç§° |
| `inputMappings` | OutputInputMappings | âœ… | - | å†…å®¹æ¥æºé…ç½® |

### è¾“å…¥é…ç½® (`inputMappings`) ç±»å‹å®šä¹‰

```typescript
type OutputMode = 'direct' | 'select' | 'merge' | 'template';

interface ContentSource {
  type: 'variable' | 'static';
  value: string;
  label?: string;
}

interface AttachmentSource {
  type: 'variable' | 'static';
  value: string;
}

interface OutputInputMappings {
  mode: OutputMode;
  sources?: ContentSource[];
  template?: string;
  attachments?: AttachmentSource[];
}
```

### æ‰§è¡Œé€»è¾‘ (OutputNodeExecutor.ts)

```typescript
// 1. æ”¶é›†å˜é‡ï¼ˆä¿ç•™åŸå§‹ç±»å‹ï¼Œç”¨äºé™„ä»¶ï¼‰
const variables = collectDirectUpstreamVariables(context, allNodes);

// 2. è½¬æ¢ä¸ºå­—ç¬¦ä¸²ç‰ˆæœ¬ï¼ˆç”¨äºæ¨¡æ¿æ›¿æ¢ï¼‰
const stringVariables: Record<string, string> = {};
for (const [key, value] of Object.entries(variables)) {
  stringVariables[key] = valueToString(value);
}

// 3. æ ¹æ®æ¨¡å¼å¤„ç†
const mode = inputMappings?.mode || 'direct';
switch (mode) {
  case 'direct': 
    // ä½¿ç”¨ç¬¬ä¸€ä¸ª source
    text = resolveSource(sources[0], variables, stringVariables);
    break;
  case 'select':
    // å–ç¬¬ä¸€ä¸ªéç©ºç»“æœ
    for (const source of sources) {
      const resolved = resolveSource(source, ...);
      if (resolved && resolved.trim() && !resolved.includes('{{')) {
        text = resolved;
        break;
      }
    }
    break;
  case 'merge':
    // è¿æ¥æ‰€æœ‰éç©ºç»“æœï¼ˆç”¨ \n\n åˆ†éš”ï¼‰
    const parts = sources
      .map(s => resolveSource(s, ...))
      .filter(r => r && r.trim());
    text = parts.join('\n\n');
    break;
  case 'template':
    // æ›¿æ¢æ¨¡æ¿ä¸­çš„å˜é‡
    text = replaceVariables(template, stringVariables, false);
    break;
}

// 4. å¤„ç†é™„ä»¶
const attachments = resolveAttachments(inputMappings?.attachments, variables);
```

---

### æ¨¡å¼è¯¦è§£

#### æ¨¡å¼ 1ï¼š`direct` - ç›´æ¥å¼•ç”¨

æœ€ç®€å•çš„åœºæ™¯ï¼šè¾“å‡ºæ¥è‡ªå•ä¸€ä¸Šæ¸¸èŠ‚ç‚¹çš„æŸä¸ªå­—æ®µã€‚

**é…ç½®ç¤ºä¾‹ï¼š**
```json
{
  "mode": "direct",
  "sources": [
    { "type": "variable", "value": "{{LLMå›å¤.response}}" }
  ]
}
```

**é€‚ç”¨åœºæ™¯ï¼š** ç®€å•çš„ Input â†’ LLM â†’ Output æµç¨‹

> [!WARNING]
> `direct` æ¨¡å¼**å¿…é¡»**é…ç½®è‡³å°‘ä¸€ä¸ªæ¥æºï¼Œå¦åˆ™æŠ›å‡ºé”™è¯¯ï¼š  
> `"Output èŠ‚ç‚¹é…ç½®é”™è¯¯ï¼šdirect æ¨¡å¼éœ€è¦è‡³å°‘é…ç½®ä¸€ä¸ªæ¥æº (sources)"`

---

#### æ¨¡å¼ 2ï¼š`select` - åˆ†æ”¯é€‰æ‹©

å¤šåˆ†æ”¯åœºæ™¯ï¼šä»å¤šä¸ªå€™é€‰ä¸­é€‰æ‹©**ç¬¬ä¸€ä¸ªéç©º**ç»“æœã€‚

**é…ç½®ç¤ºä¾‹ï¼š**
```json
{
  "mode": "select",
  "sources": [
    { "type": "variable", "value": "{{æŠ€æœ¯æ”¯æŒ.response}}" },
    { "type": "variable", "value": "{{é”€å”®å’¨è¯¢.response}}" },
    { "type": "variable", "value": "{{é€šç”¨å›å¤.response}}" }
  ]
}
```

**é€‰æ‹©é€»è¾‘ï¼š**
```typescript
for (const source of sources) {
  const resolved = resolveSource(source, ...);
  // éç©º + å»é™¤ç©ºç™½åéç©º + ä¸å«æœªæ›¿æ¢çš„ {{å˜é‡}}
  if (resolved && resolved.trim() && !resolved.includes('{{')) {
    text = resolved;
    break;
  }
}
```

**é€‚ç”¨åœºæ™¯ï¼š** Branch èŠ‚ç‚¹åçš„å¤šè·¯å¾„æ±‡èšã€æ¡ä»¶åˆ†æµ

---

#### æ¨¡å¼ 3ï¼š`merge` - å†…å®¹åˆå¹¶

ç»„åˆå¤šä¸ªæ¥æºçš„å†…å®¹ä¸ºä¸€ä¸ªè¾“å‡ºï¼Œç”¨**åŒæ¢è¡Œ**åˆ†éš”ã€‚

**é…ç½®ç¤ºä¾‹ï¼š**
```json
{
  "mode": "merge",
  "sources": [
    { "type": "variable", "value": "{{æ‘˜è¦ç”Ÿæˆ.response}}" },
    { "type": "variable", "value": "{{è¯¦ç»†åˆ†æ.response}}" }
  ]
}
```

**åˆå¹¶é€»è¾‘ï¼š**
```typescript
const parts: string[] = [];
for (const source of sources) {
  const resolved = resolveSource(source, ...);
  if (resolved && resolved.trim() && !resolved.includes('{{')) {
    parts.push(resolved);
  }
}
text = parts.join('\n\n');
```

**é€‚ç”¨åœºæ™¯ï¼š** æ‘˜è¦ + è¯¦æƒ…ç»„åˆã€å¤šç»“æœèšåˆ

---

#### æ¨¡å¼ 4ï¼š`template` - æ¨¡æ¿æ¸²æŸ“

å®Œå…¨è‡ªå®šä¹‰è¾“å‡ºæ ¼å¼ï¼Œæ”¯æŒ `{{å˜é‡å}}` è¯­æ³•ã€‚

**é…ç½®ç¤ºä¾‹ï¼š**
```json
{
  "mode": "template",
  "template": "## ç”¨æˆ·é—®é¢˜\n{{user_input}}\n\n## AI å›å¤\n{{LLMå¤„ç†.response}}"
}
```

**é€‚ç”¨åœºæ™¯ï¼š** è‡ªå®šä¹‰æŠ¥å‘Šæ ¼å¼ã€å¤šå­—æ®µç»“æ„åŒ–å±•ç¤º

> [!WARNING]
> `template` æ¨¡å¼**å¿…é¡»**é…ç½® `template` å­—æ®µï¼Œå¦åˆ™æŠ›å‡ºé”™è¯¯ï¼š  
> `"Output èŠ‚ç‚¹é…ç½®é”™è¯¯ï¼štemplate æ¨¡å¼éœ€è¦é…ç½®æ¨¡æ¿å†…å®¹ (template)"`

---

### é™„ä»¶é…ç½®ï¼ˆå¯é€‰ï¼‰

æ‰€æœ‰æ¨¡å¼éƒ½æ”¯æŒå¯é€‰çš„ `attachments` é…ç½®ï¼š

```json
{
  "mode": "direct",
  "sources": [{ "type": "variable", "value": "{{response}}" }],
  "attachments": [
    { "type": "variable", "value": "{{ç”¨æˆ·è¾“å…¥.files}}" }
  ]
}
```

**é™„ä»¶è§£æé€»è¾‘ï¼š**
```typescript
function resolveAttachments(attachments, variables) {
  const result = [];
  for (const attachment of attachments) {
    // è§£æ {{varName}} æ ¼å¼
    const varMatch = attachment.value.match(/\{\{(.+?)\}\}/);
    const varName = varMatch[1];
    const value = variables[varName];
    
    // å¦‚æœæ˜¯æ–‡ä»¶æ•°ç»„
    if (Array.isArray(value)) {
      for (const file of value) {
        if (file && 'name' in file) {
          result.push({ name: file.name, url: file.url, type: file.type });
        }
      }
    }
  }
  return result;
}
```

### è¾“å‡ºæ ¼å¼

```typescript
{
  text: string;                                              // æœ€ç»ˆå±•ç¤ºçš„æ–‡æœ¬å†…å®¹
  attachments?: { name: string; url: string; type?: string }[] // å¯é€‰é™„ä»¶
}
```

> [!IMPORTANT]
> Output èŠ‚ç‚¹**å¿…é¡»æ˜¾å¼é…ç½®** `inputMappings`ï¼Œä¸å†æ”¯æŒè‡ªåŠ¨æå–ã€‚

---

## ğŸ”„ å·¥ä½œæµç¼–æ’æ ¸å¿ƒæœºåˆ¶

### 1ï¸âƒ£ FlowContext ä¸Šä¸‹æ–‡ç»“æ„

å·¥ä½œæµä½¿ç”¨ `FlowContext` ä½œä¸ºå…¨å±€ä¸Šä¸‹æ–‡ï¼Œé‡‡ç”¨**é”®å€¼å¯¹æ˜ å°„**å­˜å‚¨æ¯ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºï¼š

```typescript
interface FlowContext {
  [nodeId: string]: Record<string, unknown>;  // èŠ‚ç‚¹ID â†’ è¾“å‡ºæ•°æ®
  _meta?: {                                    // å…ƒæ•°æ®ï¼ˆä»¥ _ å¼€å¤´ï¼‰
    flowId: string;
    sessionId: string;
    nodeLabels?: Record<string, string>;  // nodeId â†’ label æ˜ å°„
  }
}
```

**ç¤ºä¾‹**:
```javascript
{
  "input_abc123": {
    "user_input": "å¸®æˆ‘å†™ä¸€ç¯‡æ–‡ç« ",
    "timestamp": "2025-12-07T00:00:00Z"
  },
  "llm_def456": {
    "response": "è¿™æ˜¯ç”Ÿæˆçš„æ–‡ç« å†…å®¹..."
  },
  "_meta": {
    "flowId": "flow_xyz",
    "sessionId": "session_123",
    "nodeLabels": {
      "input_abc123": "ç”¨æˆ·è¾“å…¥",
      "llm_def456": "æ–‡ç« ç”Ÿæˆ"
    }
  }
}
```

---

### 2ï¸âƒ£ èŠ‚ç‚¹è¾“å‡ºæ ‡å‡†æ ¼å¼

| èŠ‚ç‚¹ç±»å‹ | ä¸»è¦è¾“å‡ºå­—æ®µ | è¾“å‡ºç¤ºä¾‹ |
|---------|-------------|---------|
| **Input** | `user_input`, `timestamp`, `files?`, `formData?` | `{user_input: "ç”¨æˆ·è¾“å…¥", timestamp: "..."}` |
| **LLM** | `response` | `{response: "AIç”Ÿæˆçš„å›å¤å†…å®¹"}` |
| **RAG** | `query`, `documents`, `citations`, `documentCount`, `mode` | `{query: "æ£€ç´¢è¯", documents: [...], mode: "fileSearch"}` |
| **Tool** | å·¥å…·ç‰¹å®šå­—æ®µ | æ ¹æ®å·¥å…·ç±»å‹ä¸åŒ |
| **Branch** | `conditionResult`, `passed`, é€ä¼ æ•°æ® | `{conditionResult: true, passed: true, ...}` |
| **Output** | `text`, `attachments?` | `{text: "æœ€ç»ˆå±•ç¤ºæ–‡æœ¬"}` |

---

### 3ï¸âƒ£ å˜é‡å¼•ç”¨æœºåˆ¶

#### æ”¯æŒçš„å¼•ç”¨æ ¼å¼

| æ ¼å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `{{field_name}}` | ç›´æ¥ä½¿ç”¨å­—æ®µåï¼ˆåœ¨æ‰€æœ‰ä¸Šæ¸¸èŠ‚ç‚¹ä¸­æŸ¥æ‰¾ï¼‰ | `{{user_input}}`, `{{response}}` |
| `{{èŠ‚ç‚¹åç§°.field_name}}` | ä½¿ç”¨èŠ‚ç‚¹ label å‰ç¼€ï¼ˆæ¨èï¼Œæ›´æ˜ç¡®ï¼‰ | `{{è·å–å½“å‰æ—¶é—´.formatted}}` |
| `{{node_id.field_name}}` | ä½¿ç”¨èŠ‚ç‚¹ ID å‰ç¼€ | `{{tool_abc123.formatted}}` |

#### å˜é‡æ”¶é›†æœºåˆ¶ (variableUtils.ts)

```typescript
function collectVariables(context, globalFlowContext, allNodes) {
  const allVariables = {};
  
  // 1. å…ˆä»å…¨å±€ flowContext æå–ï¼ˆè¾ƒæ—©æ‰§è¡Œçš„èŠ‚ç‚¹ï¼‰
  for (const [nodeId, nodeOutput] of Object.entries(globalFlowContext)) {
    if (context[nodeId]) continue;  // è·³è¿‡ç›´æ¥ä¸Šæ¸¸ï¼ˆåé¢å¤„ç†ï¼‰
    flattenObject(nodeOutput, allVariables);            // {{fieldName}}
    flattenObject(nodeOutput, allVariables, nodeLabel); // {{èŠ‚ç‚¹åç§°.fieldName}}
    flattenObject(nodeOutput, allVariables, nodeId);    // {{nodeId.fieldName}}
  }
  
  // 2. æœ€åä»ç›´æ¥ä¸Šæ¸¸ context æå–ï¼ˆä¼šè¦†ç›–å…¨å±€åŒåå˜é‡ï¼‰
  // ç¡®ä¿ç›´æ¥ä¸Šæ¸¸ä¼˜å…ˆçº§æœ€é«˜
  for (const [nodeId, nodeOutput] of Object.entries(context)) {
    flattenObject(nodeOutput, allVariables);
    flattenObject(nodeOutput, allVariables, nodeLabel);
    flattenObject(nodeOutput, allVariables, nodeId);
    
    // æ·»åŠ è‡ªå®šä¹‰è¾“å‡ºå˜é‡
    if (customOutputs) {
      customOutputs.forEach(cv => {
        allVariables[cv.name] = cv.value;
        allVariables[`${nodeLabel}.${cv.name}`] = cv.value;
      });
    }
  }
  
  return allVariables;
}
```

#### å˜é‡æ¥æºä¼˜å…ˆçº§

1. **ç›´æ¥ä¸Šæ¸¸** context ä¸­çš„èŠ‚ç‚¹è¾“å‡ºï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. **å…¨å±€** flowContext ä¸­çš„èŠ‚ç‚¹è¾“å‡º

#### å˜é‡æœªæ‰¾åˆ°æ—¶çš„å¤„ç†

- æ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²
- æ§åˆ¶å°è¾“å‡ºè­¦å‘Šä¿¡æ¯ï¼š`[PromptParser] æœªæ‰¾åˆ°å˜é‡: xxxï¼Œå·²æ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²`

#### å®é™…ç¤ºä¾‹

å‡è®¾å·¥ä½œæµä¸­æœ‰ä»¥ä¸‹èŠ‚ç‚¹ï¼š
- **Input èŠ‚ç‚¹**: è¾“å‡º `{ user_input: "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·" }`
- **æ—¥æœŸæ—¶é—´å·¥å…·**ï¼ˆlabel: `è·å–å½“å‰æ—¶é—´`ï¼‰: è¾“å‡º `{ formatted: "2025-12-07 11:30:00" }`

åœ¨ LLM èŠ‚ç‚¹çš„ `systemPrompt` ä¸­å¯ä»¥è¿™æ ·å¼•ç”¨ï¼š

```
å½“å‰æ—¶é—´ï¼š{{è·å–å½“å‰æ—¶é—´.formatted}}
ç”¨æˆ·é—®é¢˜ï¼š{{user_input}}
```

æ‰§è¡Œæ—¶è‡ªåŠ¨æ›¿æ¢ä¸ºï¼š

```
å½“å‰æ—¶é—´ï¼š2025-12-07 11:30:00
ç”¨æˆ·é—®é¢˜ï¼šä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·
```

---

### 4ï¸âƒ£ æ•°æ®æå–ä¼˜å…ˆçº§ (contextUtils.ts)

`extractTextFromUpstream()` å‡½æ•°æ™ºèƒ½æå–æ–‡æœ¬å†…å®¹ï¼š

```typescript
const TEXT_FIELD_PRIORITY = ['text', 'response', 'user_input', 'query'];

function extractTextFromUpstream(data, fallbackToJson = true) {
  // 1. å­—ç¬¦ä¸²ç›´æ¥è¿”å›
  if (typeof data === 'string') return data;
  
  // 2. æŒ‰ä¼˜å…ˆçº§å°è¯•æå–
  for (const field of TEXT_FIELD_PRIORITY) {
    if (typeof obj[field] === 'string' && obj[field].trim()) {
      return obj[field];
    }
  }
  
  // 3. Branch èŠ‚ç‚¹ç‰¹æ®Šå¤„ç†ï¼ˆè¿‡æ»¤å…ƒæ•°æ®å­—æ®µï¼‰
  if ('conditionResult' in obj) {
    const cleanedData = Object.fromEntries(
      Object.entries(obj).filter(([key]) => 
        !['conditionResult', 'passed', 'value'].includes(key)
      )
    );
    // ä»æ¸…ç†åçš„æ•°æ®ä¸­å†æ¬¡æå–
    for (const field of TEXT_FIELD_PRIORITY) {
      if (cleanedData[field]) return cleanedData[field];
    }
  }
  
  // 4. å…œåº•ï¼šJSON å­—ç¬¦ä¸²
  return fallbackToJson ? JSON.stringify(data) : "";
}
```

---

### 5ï¸âƒ£ æ‰§è¡Œæµç¨‹æ§åˆ¶

#### æ‹“æ‰‘æ’åºæ‰§è¡Œ

ç³»ç»Ÿä½¿ç”¨æ‹“æ‰‘æ’åºç¡®ä¿èŠ‚ç‚¹æŒ‰ä¾èµ–å…³ç³»æ­£ç¡®æ‰§è¡Œï¼š

```mermaid
graph LR
    A[Input] --> B[LLM]
    A --> C[RAG]
    B --> D[Output]
    C --> D
```

æ‰§è¡Œé¡ºåºï¼š`Input â†’ LLM/RAG (å¹¶è¡Œ) â†’ Output`

#### Branch èŠ‚ç‚¹çš„è·¯å¾„é€‰æ‹©

```mermaid
graph TD
    A[ä¸Šæ¸¸èŠ‚ç‚¹] --> B[Branch]
    B -->|TRUE| C[LLM-A]
    B -->|FALSE| D[LLM-B]
    C --> E[Output]
    D --> E
```

1. è¯„ä¼°æ¡ä»¶è¡¨è¾¾å¼ï¼Œå¾—åˆ° `conditionResult`
2. åªæ‰§è¡Œå¯¹åº”å¥æŸ„è¿æ¥çš„ä¸‹æ¸¸èŠ‚ç‚¹
3. å¦ä¸€æ¡è·¯å¾„çš„èŠ‚ç‚¹ä¼šè¢«è·³è¿‡

---

## ğŸ›ï¸ èŠ‚ç‚¹å‚æ•°é¢æ¿

ç‚¹å‡»ä»»æ„èŠ‚ç‚¹åï¼Œå³ä¾§å¼¹å‡ºçš„å‚æ•°é¢æ¿åŒ…å«ä»¥ä¸‹åŒºåŸŸï¼š

### 1ï¸âƒ£ éœ€è¦çš„ä¸Šæ¸¸è¾“å…¥ï¼ˆâš™ï¸ é…ç½®å‚æ•°ï¼‰

æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹éœ€è¦é…ç½®çš„è¾“å…¥å‚æ•°ï¼š

| èŠ‚ç‚¹ç±»å‹ | å¯é…ç½®çš„è¾“å…¥å‚æ•° |
|---------|------------------|
| **LLM** | `user_input` - ç”¨æˆ·æ¶ˆæ¯å†…å®¹ |
| **RAG** | `query` - æ£€ç´¢æŸ¥è¯¢æ–‡æœ¬ |
| **Tool** | æ ¹æ®å·¥å…·ç±»å‹åŠ¨æ€æ˜¾ç¤ºæ‰€æœ‰å¿…å¡«/å¯é€‰å‚æ•° |
| **Branch** | æ— éœ€é…ç½®ï¼ˆcondition è¡¨è¾¾å¼å·²å®šä¹‰æ•°æ®æ¥æºï¼‰ |
| **Output** | é€šè¿‡ UI é…ç½® `mode` å’Œ `sources`/`template` |

**é…ç½®æ–¹å¼**:
- ç›´æ¥è¾“å…¥å›ºå®šå€¼ï¼š`åŒ—äº¬`
- å¼•ç”¨ä¸Šæ¸¸å˜é‡ï¼š`{{user_input}}` æˆ– `{{èŠ‚ç‚¹åç§°.å­—æ®µå}}`

**çŠ¶æ€é¢œè‰²**:
- ğŸŸ¢ **ç»¿è‰² + âœ“** = å·²é…ç½®æˆ–ä¸Šæ¸¸å·²æä¾›
- ğŸŸ  **æ©™è‰²** = å¿…å¡«ä½†æœªé…ç½®
- âšª **ç°è‰²** = å¯é€‰å‚æ•°

**æ•°æ®å­˜å‚¨**:
- Tool èŠ‚ç‚¹ â†’ `node.data.inputs`
- LLM/RAG èŠ‚ç‚¹ â†’ `node.data.inputMappings`
- Output èŠ‚ç‚¹ â†’ `node.data.inputMappings`

---

### 2ï¸âƒ£ å¼•ç”¨çš„å˜é‡ï¼ˆğŸ”—ï¼‰

åŠ¨æ€æ£€æµ‹å½“å‰èŠ‚ç‚¹é…ç½®ä¸­å¼•ç”¨çš„ `{{å˜é‡å}}` å ä½ç¬¦ï¼š

**æ£€æµ‹èŒƒå›´**:
- LLM èŠ‚ç‚¹ï¼š`systemPrompt` ä¸­çš„å˜é‡
- Tool èŠ‚ç‚¹ï¼š`inputs` å‚æ•°ä¸­çš„å˜é‡
- Branch èŠ‚ç‚¹ï¼šæ¡ä»¶è¡¨è¾¾å¼ä¸­çš„ `èŠ‚ç‚¹åç§°.xxx`
- Output èŠ‚ç‚¹ï¼š`sources` å’Œ `template` ä¸­çš„å˜é‡

**çŠ¶æ€æŒ‡ç¤º**:
- ğŸŸ¢ **ç»¿è‰² âœ“** = å˜é‡å¯ä»ä¸Šæ¸¸è·å–
- ğŸŸ  **æ©™è‰²** = å˜é‡æœªåŒ¹é…ä¸Šæ¸¸è¾“å‡º

---

### 3ï¸âƒ£ å¯ç”¨è¾“å…¥å˜é‡ï¼ˆâ¬‡ï¸ï¼‰

æ˜¾ç¤ºæ‰€æœ‰ä¸Šæ¸¸èŠ‚ç‚¹çš„è¾“å‡ºå­—æ®µï¼š

**æ˜¾ç¤ºæ ¼å¼**: `{{èŠ‚ç‚¹åç§°.å­—æ®µå}}`

**æ“ä½œ**:
- ç‚¹å‡»å¤åˆ¶æŒ‰é’®ï¼Œè‡ªåŠ¨å¤åˆ¶å®Œæ•´å˜é‡å¼•ç”¨
- æ˜¾ç¤ºå½“å‰æ‰§è¡Œç»“æœå€¼ï¼ˆå¦‚æœ‰ï¼‰

---

### 4ï¸âƒ£ è¾“å‡ºå‚æ•°ï¼ˆâ¬†ï¸ï¼‰

æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹æ‰§è¡Œåä¼šè¾“å‡ºçš„å­—æ®µï¼š

#### ç³»ç»Ÿé¢„å®šä¹‰è¾“å‡ºï¼ˆğŸŸ¢ ç»¿è‰²ï¼‰

| èŠ‚ç‚¹ç±»å‹ | è¾“å‡ºå­—æ®µ |
|---------|---------| 
| **Input** | `user_input`, `timestamp`, `files`, `formData` |
| **LLM** | `response` |
| **RAG** | `query`, `documents`, `citations`, `documentCount` |
| **Tool** | æ ¹æ®å·¥å…·ç±»å‹ä¸åŒ |
| **Branch** | `conditionResult`, `passed`, é€ä¼ æ•°æ® |
| **Output** | `text`, `attachments` |

#### Tool èŠ‚ç‚¹è¾“å‡ºè¯¦æƒ…

| å·¥å…·ç±»å‹ | è¾“å‡ºå­—æ®µ |
|---------|---------| 
| `web_search` | `results`, `count` |
| `calculator` | `expression`, `result` |
| `datetime` | `formatted`, `timestamp`, `timezone` |
| `weather` | `city`, `weather`, `summary` |
| `url_reader` | `url`, `title`, `content`, `contentLength`, `truncated` |

#### ç”¨æˆ·è‡ªå®šä¹‰å˜é‡ï¼ˆğŸŸ£ ç´«è‰²ï¼‰

ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æ·»åŠ è‡ªå®šä¹‰è¾“å‡ºå˜é‡ï¼Œä¾›ä¸‹æ¸¸èŠ‚ç‚¹å¼•ç”¨ï¼š

**æ·»åŠ æ–¹å¼**:
1. ç‚¹å‡» **"+ æ·»åŠ è‡ªå®šä¹‰å˜é‡"** æŒ‰é’®
2. è¾“å…¥å˜é‡åå’Œé»˜è®¤å€¼
3. æŒ‰ Enter æˆ–ç‚¹å‡» âœ“ ç¡®è®¤

**å­˜å‚¨ä½ç½®**: `node.data.customOutputs: { name: string; value: string }[]`

---

### 5ï¸âƒ£ æœ€è¿‘ä¸€æ¬¡æ‰§è¡Œè¾“å‡º

æ˜¾ç¤ºèŠ‚ç‚¹æœ€è¿‘ä¸€æ¬¡æ‰§è¡Œçš„åŸå§‹ JSON è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•å’ŒéªŒè¯æ•°æ®ç»“æ„ã€‚

---

## ğŸ›¡ï¸ å®‰å…¨ä¸å®¹é”™æœºåˆ¶

### å¾ªç¯ä¾èµ–æ£€æµ‹

æ‰§è¡Œå‰é€šè¿‡ DFS éå†æ£€æµ‹å¾ªç¯ä¾èµ–ï¼Œå‘ç°å¾ªç¯ç«‹å³è¿”å›é”™è¯¯ã€‚

### å¹¶å‘æ‰§è¡Œæ§åˆ¶

ä½¿ç”¨ `_executionLock` æ‰§è¡Œé”é˜²æ­¢å¤šæ¬¡ç‚¹å‡»å¯¼è‡´ï¼š
- é…é¢é‡å¤æ‰£å‡
- çŠ¶æ€ç«äº‰

### å‚æ•°éªŒè¯

| èŠ‚ç‚¹ç±»å‹ | éªŒè¯æœºåˆ¶ |
|---------|---------|
| RAG | æ£€æŸ¥ `files` æ•°ç»„éç©ºã€`fileSearchStoreName` å·²é…ç½® |
| Tool | Zod Schema äºŒæ¬¡éªŒè¯ |
| Branch | ç™½åå•è¡¨è¾¾å¼åŒ¹é…ï¼ˆéç™½åå•è¿”å› falseï¼‰ |
| Output | æ¨¡å¼ä¸é…ç½®ä¸€è‡´æ€§æ£€æŸ¥ |

### æ•æ„Ÿæ•°æ®è¿‡æ»¤

- Branch é€ä¼ æ—¶è¿‡æ»¤ `_` å¼€å¤´å­—æ®µ
- FlowContext è¿‡æ»¤ `_meta` ç­‰å†…éƒ¨å­—æ®µ
- å˜é‡æ”¶é›†æ—¶è·³è¿‡ `_` å¼€å¤´çš„é”®

### é…é¢æ£€æŸ¥

- ä»…æ­£å¼æ‰§è¡Œï¼ˆ`runFlow`ï¼‰è§¦å‘ï¼Œè°ƒè¯•æ¨¡å¼è·³è¿‡
- LLM èŠ‚ç‚¹æ‰§è¡Œå‰æŸ¥è¯¢ `quotaService.checkQuota()`
- é…é¢ä¸è¶³æ—¶ä¸­æ­¢æ•´ä¸ªå·¥ä½œæµ

---

## ğŸ”§ è°ƒè¯•æœºåˆ¶

### å•èŠ‚ç‚¹è°ƒè¯•

**è§¦å‘æ¡ä»¶**:
- ç‚¹å‡»èŠ‚ç‚¹çš„"è¿è¡Œ"æŒ‰é’®
- èŠ‚ç‚¹æœ‰ä¸Šæ¸¸è¿æ¥ä½†ç¼ºå°‘è¾“å…¥æ•°æ®

**è°ƒè¯•æ¨¡å¼**:
- **LLM èŠ‚ç‚¹**: æ‰“å¼€è°ƒè¯•å¯¹è¯æ¡†ï¼Œè¾“å…¥ mock å˜é‡å€¼
- **RAG èŠ‚ç‚¹**: æ‰“å¼€è°ƒè¯•å¯¹è¯æ¡†ï¼Œè¾“å…¥ mock æŸ¥è¯¢
- **Tool èŠ‚ç‚¹**: æ‰“å¼€è°ƒè¯•å¯¹è¯æ¡†ï¼Œè¾“å…¥ mock å‚æ•°

**Mock æ•°æ®ä½¿ç”¨**:
```typescript
// è°ƒè¯•æ¨¡å¼åˆ¤æ–­
const effectiveMockData = mockData || (context.mock as Record<string, unknown>);

if (effectiveMockData && Object.keys(effectiveMockData).length > 0) {
  // ä½¿ç”¨ mock æ•°æ®æ›¿æ¢å˜é‡
  const stringValues = {};
  Object.entries(effectiveMockData).forEach(([key, value]) => {
    stringValues[key] = String(value);
  });
  systemPrompt = replaceVariables(systemPrompt, stringValues);
}
```

---

## âš ï¸ å¸¸è§é”™è¯¯åœºæ™¯ä¸é¢„é˜²

| åœºæ™¯ | é”™è¯¯ä¿¡æ¯ | é¢„é˜²æªæ–½ |
|------|---------|----------|
| RAG ç©ºçŸ¥è¯†åº“ | `"çŸ¥è¯†åº“ä¸ºç©ºï¼Œè¯·å…ˆä¸Šä¼ è‡³å°‘ä¸€ä¸ªæ–‡ä»¶ã€‚"` | `files` æ•°ç»„éç©ºéªŒè¯ |
| RAG æœªé…ç½® Store | `"RAG èŠ‚ç‚¹æœªé…ç½® File Search Storeã€‚è¯·å…ˆä¸Šä¼ æ–‡ä»¶ã€‚"` | æ£€æŸ¥ `fileSearchStoreName` |
| LLM é…é¢è€—å°½ | `"LLM æ‰§è¡Œæ¬¡æ•°å·²ç”¨å®Œ (x/y)ã€‚è¯·è”ç³»ç®¡ç†å‘˜å¢åŠ é…é¢ã€‚"` | æ‰§è¡Œå‰ quota æ£€æŸ¥ |
| Tool å‚æ•°ç¼ºå¤± | `"å‚æ•°éªŒè¯å¤±è´¥: query: Required"` | Zod Schema éªŒè¯ |
| Branch éæ³•è¡¨è¾¾å¼ | è­¦å‘Š + é»˜è®¤è¿”å› false | ç™½åå•è¡¨è¾¾å¼åŒ¹é… |
| å¾ªç¯ä¾èµ– | `"æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–"` | æ‰§è¡Œå‰ DFS æ£€æµ‹ |
| å¹¶å‘æ‰§è¡Œ | é…é¢é‡å¤æ‰£å‡ | æ‰§è¡Œé” `_executionLock` |
| Output é…ç½®é”™è¯¯ | `"Output èŠ‚ç‚¹é…ç½®é”™è¯¯ï¼šxxx æ¨¡å¼éœ€è¦..."` | æ¨¡å¼ä¸é…ç½®ä¸€è‡´æ€§æ£€æŸ¥ |
| ç”¨æˆ·æœªç™»å½• | `"è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨ LLM åŠŸèƒ½"` | è®¤è¯çŠ¶æ€æ£€æŸ¥ |

---

## ğŸ“Š æç¤ºè¯è®¾è®¡å…³é”®ç‚¹

åŸºäºä»¥ä¸Šæœºåˆ¶ï¼Œè®¾è®¡ç”Ÿæˆ Flow çš„æç¤ºè¯æ—¶åº”é‡ç‚¹è¯´æ˜ï¼š

1. **å‚æ•°ä¼ é€’**: æ˜ç¡®æ¯ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºå­—æ®µåï¼Œä¸‹æ¸¸èŠ‚ç‚¹å¯é€šè¿‡ `{{å­—æ®µå}}` æˆ– `{{èŠ‚ç‚¹åç§°.å­—æ®µå}}` å¼•ç”¨
2. **å˜é‡å‘½å**: 
   - Input èŠ‚ç‚¹è¾“å‡º `user_input`ã€`timestamp`ã€`files`ã€`formData`
   - LLM èŠ‚ç‚¹è¾“å‡º `response`
   - RAG èŠ‚ç‚¹è¾“å‡º `query`ã€`documents`ã€`citations`ã€`documentCount`
3. **inputMappings é…ç½®**:
   - LLM èŠ‚ç‚¹éœ€è¦ `user_input`ï¼ˆé€šè¿‡ä¸Šæ¸¸ context è‡ªåŠ¨è·å–ï¼‰
   - RAG èŠ‚ç‚¹éœ€è¦ `query`ï¼ˆé…ç½® `inputMappings.query`ï¼‰
   - Output èŠ‚ç‚¹éœ€è¦ `mode` å’Œå¯¹åº”çš„ `sources`/`template`
4. **è®°å¿†é…ç½®**: ç”¨æˆ·äº¤äº’ LLM å»ºè®®å¯ç”¨è®°å¿†ï¼Œä¸­é—´å¤„ç† LLM ä¸éœ€è¦
5. **Branch æ¡ä»¶**: ä½¿ç”¨ `èŠ‚ç‚¹åç§°.å­—æ®µå` æ ¼å¼ï¼Œæ”¯æŒ `.includes()`ã€`===`ã€`>`ç­‰æ“ä½œ
6. **æ‰§è¡Œé¡ºåº**: AI è‡ªåŠ¨å¤„ç†æ‹“æ‰‘æ’åºï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®šæ‰§è¡Œé¡ºåº
7. **æ•°æ®æµå‘**: é€šè¿‡è¿çº¿ï¼ˆedgesï¼‰å®šä¹‰æ•°æ®æµå‘ï¼Œç³»ç»Ÿè‡ªåŠ¨ä¼ é€’ä¸Šä¸‹æ–‡

---