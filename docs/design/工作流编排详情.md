# ğŸ”— Flash-Flow å·¥ä½œæµç¼–æ’ä¸æ•°æ®æ‹“æ‰‘è§„èŒƒ

> **æ–‡æ¡£ç›®çš„**: æœ¬è§„èŒƒä¸º AI è‡ªåŠ¨ç”Ÿæˆå·¥ä½œæµæä¾›åº•å±‚åè®®ï¼Œç¡®ä¿ç”»å¸ƒæ‹“æ‰‘ç»“æ„åˆæ³•ã€å˜é‡å¼•ç”¨æ­£ç¡®ã€æ‰§è¡Œé€»è¾‘ç¬¦åˆé¢„æœŸã€‚

---

## 0. ç”¨æˆ·å¯è§æ–‡æ¡ˆè§„èŒƒï¼ˆé£æ ¼ + æœ¯è¯­ï¼‰

æœ¬èŠ‚ç”¨äºçº¦æŸã€Œç”¨æˆ·èƒ½çœ‹åˆ°ã€çš„æ–‡æ¡ˆï¼ˆæŒ‰é’®ã€æç¤ºã€çŠ¶æ€ã€é”™è¯¯ä¿¡æ¯ã€èŠ‚ç‚¹é…ç½®æ–‡æ¡ˆï¼‰ã€‚ç›®æ ‡æ˜¯ï¼šåœ¨ä¸ç‰ºç‰²ä¸“ä¸šæ€§çš„å‰æä¸‹ï¼Œè®©éæŠ€æœ¯ç”¨æˆ·ä¹Ÿèƒ½å¿«é€Ÿç†è§£å¹¶å®Œæˆæ“ä½œï¼ˆç›®æ ‡é˜…è¯»ç­‰çº§ â‰¤ 8 å¹´çº§ï¼‰ã€‚

### 0.1 æˆåŠŸæ ‡å‡†ï¼ˆä»ç¬¬ä¸€æ€§åŸç†å‡ºå‘ï¼‰

ç”¨æˆ·åœ¨å…³é”®è·¯å¾„ä¸Šéœ€è¦çš„æœ€å°ä¿¡æ¯åªæœ‰ä¸‰ç±»ï¼š

1. **æ­¤åˆ»æˆ‘èƒ½åšä»€ä¹ˆ**ï¼ˆè¡ŒåŠ¨æŒ‰é’®/ä¸‹ä¸€æ­¥ï¼‰
2. **ç³»ç»Ÿæ­£åœ¨åšä»€ä¹ˆ**ï¼ˆçŠ¶æ€åé¦ˆï¼‰
3. **å¦‚æœå¤±è´¥æˆ‘è¯¥æ€ä¹ˆåš**ï¼ˆå¯æ‰§è¡Œçš„çº é”™æŒ‡å¼•ï¼‰

æ–‡æ¡ˆåªè¦æ»¡è¶³è¿™ä¸‰ç±»ä¿¡æ¯ï¼Œå°±ç®—â€œè¶³å¤Ÿå¥½â€ï¼›è¶…å‡ºéƒ¨åˆ†ä¼šå¢åŠ è®¤çŸ¥è´Ÿæ‹…ã€‚

### 0.2 æ–‡æ¡ˆé£æ ¼ï¼ˆå†™ç»™ç”¨æˆ·çœ‹ï¼‰

- **çŸ­å¥ä¼˜å…ˆ**ï¼šä¸€ä¸ªå¥å­è¡¨è¾¾ä¸€ä¸ªåŠ¨ä½œæˆ–ä¸€ä¸ªç»“æœï¼›é¿å…é•¿ä¸²å¹¶åˆ—ä»å¥ã€‚
- **åŠ¨è¯å¼€å¤´**ï¼šæŒ‰é’®/æç¤ºè¯­ç”¨åŠ¨è¯èµ·å¥ï¼ˆå¦‚â€œè¿è¡Œâ€â€œè¯•è¿è¡Œâ€â€œä¸Šä¼ â€â€œæ¸…é™¤æœç´¢â€ï¼‰ã€‚
- **ä¿¡æ¯é—­ç¯**ï¼šé”™è¯¯ä¿¡æ¯å¿…é¡»åŒ…å«â€œå‘ç”Ÿäº†ä»€ä¹ˆ + æ€ä¹ˆåŠâ€ï¼›é¿å…åªè¯´â€œå¤±è´¥/å¼‚å¸¸â€ã€‚
- **é¿å…æœ¯è¯­å †å **ï¼šç”¨æˆ·ä¸éœ€è¦çŸ¥é“ JSON/Handlebars/NodeID/SSE ç­‰å†…éƒ¨æ¦‚å¿µã€‚
- **ä¸€è‡´æ€§ä¼˜å…ˆ**ï¼šåŒç±»çŠ¶æ€/åŠ¨ä½œåœ¨å…¨ç«™ä½¿ç”¨åŒä¸€å¥—è¯ï¼ˆå‡å°‘å­¦ä¹ æˆæœ¬ï¼‰ã€‚

### 0.3 æ ‡ç‚¹ä¸æ ¼å¼ï¼ˆé™ä½é˜…è¯»æ‘©æ“¦ï¼‰

- è¿›è¡Œä¸­çŠ¶æ€ç»Ÿä¸€ä½¿ç”¨ä¸­æ–‡çœç•¥å·ï¼š**â€¦**ï¼ˆä¾‹å¦‚â€œåŠ è½½ä¸­â€¦â€â€œä¸Šä¼ ä¸­â€¦â€â€œè¿è¡Œä¸­â€¦â€ï¼‰ã€‚
- Tooltip/çŸ­æç¤ºé¿å…å åŠ è¯­æ°”è¯ï¼šä¸ä½¿ç”¨â€œè¯·â€â€œä¸€ä¸‹â€ç­‰å¼±åŒ–æŒ‡ä»¤çš„è¯ã€‚
- æ•°å­—ä¸å•ä½ï¼šä½¿ç”¨ç´§å‡‘æ ¼å¼ï¼ˆå¦‚â€œ10MBâ€â€œ3è½®â€ï¼‰ï¼Œé¿å…å†—ä½™ç©ºæ ¼ã€‚

### 0.4 æœ¯è¯­è¡¨ï¼ˆå…¨ç«™ç»Ÿä¸€å£å¾„ï¼‰

| æ¦‚å¿µ | é¢å‘ç”¨æˆ·çš„æ¨èè¯´æ³• | ä¸æ¨è | ä½¿ç”¨è¾¹ç•Œ |
|---|---|---|---|
| Flowï¼ˆäº§å“å¯¹è±¡ï¼‰ | å·¥ä½œæµ / å·¥ä½œæµåº”ç”¨ | Flow | åˆ—è¡¨é¡µã€åˆ›å»ºã€è¿è¡Œã€åˆ†äº«ç­‰äº§å“å±‚é¢ |
| Agentï¼ˆäº§å“å¯¹è±¡ï¼‰ | æ™ºèƒ½ä½“ | Agent | å½“äº§å“å¯¹å¤–ä»¥â€œæ™ºèƒ½ä½“â€å‘½åæ—¶ä½¿ç”¨ï¼ˆå¦‚â€œæˆ‘çš„æ™ºèƒ½ä½“â€ï¼‰ |
| AIï¼ˆèƒ½åŠ›ï¼‰ | AI | æ™ºèƒ½ä½“ï¼ˆæ³›æŒ‡èƒ½åŠ›æ—¶ï¼‰ | æè¿°èƒ½åŠ›æ¥æºæ—¶ä½¿ç”¨ï¼ˆå¦‚â€œAI ç”Ÿæˆâ€â€œAI ç”ŸæˆåŠŸèƒ½â€ï¼‰ |
| Planï¼ˆä¸­é—´äº§ç‰©ï¼‰ | å·¥ä½œæµæ–¹æ¡ˆ | ä»»åŠ¡è“å›¾ | Copilot/Agent åœºæ™¯ä¸­å¯¹â€œè§„åˆ’ç»“æœâ€çš„ç§°å‘¼ |
| Nodeï¼ˆç”»å¸ƒå…ƒç´ ï¼‰ | èŠ‚ç‚¹ | æ¨¡å—/ç»„ä»¶ï¼ˆæ··ç”¨ï¼‰ | ç”»å¸ƒä¸é…ç½®é¢æ¿ï¼Œå§‹ç»ˆç”¨â€œèŠ‚ç‚¹â€ |
| å˜é‡å¼•ç”¨ | å˜é‡å¼•ç”¨ / å˜é‡ | æ¨¡æ¿è¯­æ³• | ä»…åœ¨å¿…é¡»è®©ç”¨æˆ·ç†è§£ `{{ }}` æ—¶æåŠ |
| æµ‹è¯•è¿è¡Œï¼ˆå•èŠ‚ç‚¹ï¼‰ | è¯•è¿è¡Œ | æµ‹è¯• | ç”¨äºè°ƒè¯•è¿è¡Œå•ä¸ªèŠ‚ç‚¹ï¼Œé¿å…ä¸â€œå•å…ƒæµ‹è¯•â€æ··æ·† |

### 0.5 äº¤äº’æ–‡æ¡ˆæ¨¡æ¿ï¼ˆå¯ç›´æ¥å¤ç”¨ï¼‰

| åœºæ™¯ | æ¨èæ¨¡æ¿ | è¯´æ˜ |
|---|---|---|
| è¿è¡Œç±»æŒ‰é’® | `è¿è¡Œ` / `è¿è¡Œæ­¤èŠ‚ç‚¹` | Button ç”¨çŸ­è¯ï¼ŒTooltip ç”¨æ›´æ˜ç¡®çš„å¯¹è±¡ |
| è¿›è¡Œä¸­çŠ¶æ€ | `åŠ è½½ä¸­â€¦` `ä¸Šä¼ ä¸­â€¦` `è¿è¡Œä¸­â€¦` `åˆ›å»ºä¸­â€¦` | ç»Ÿä¸€ç”¨ä¸­æ–‡çœç•¥å· |
| ç©ºçŠ¶æ€ | `è¿˜æ²¡æœ‰â€¦` + `å»åˆ›å»ºä¸€ä¸ªå§` | å…ˆæè¿°ç°çŠ¶ï¼Œå†ç»™å‡ºè½»é‡è¡ŒåŠ¨ |
| ç½‘ç»œ/æœåŠ¡é”™è¯¯ | `ç½‘ç»œè¿æ¥å¤±è´¥` + `è¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•` | å…ˆå½’å› å†ç»™åŠ¨ä½œï¼Œé¿å…â€œæœªçŸ¥é”™è¯¯â€ |
| è§„åˆ’é™çº§æç¤º | `è§„åˆ’é˜¶æ®µæœªäº§å‡ºæœ‰æ•ˆè®¡åˆ’â€¦` | è¯´æ˜åŸå›  + ç³»ç»Ÿå°†å¦‚ä½•ç»§ç»­ |

---

## 1. æ‹“æ‰‘è¿æ¥å¥‘çº¦ (Connection Rules)

### 1.1 èŠ‚ç‚¹ç«¯å£è§„åˆ™ (Handle Rules)

æ¯ä¸ªèŠ‚ç‚¹å…·å¤‡è¾“å…¥ç«¯å£ (Target Handle) å’Œè¾“å‡ºç«¯å£ (Source Handle)ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š

| èŠ‚ç‚¹ç±»å‹ | è¾“å…¥ç«¯å£ (target) | è¾“å‡ºç«¯å£ (source) | å¤‡æ³¨ |
|---------|------------------|------------------|------|
| **Input** | âŒ æ—  | âœ… å•ä¸ª (null) | å·¥ä½œæµèµ·ç‚¹ï¼Œæ— ä¸Šæ¸¸ä¾èµ– |
| **LLM** | âœ… å•ä¸ª | âœ… å•ä¸ª (null) | å¤šå…¥å•å‡º |
| **RAG** | âœ… å•ä¸ª | âœ… å•ä¸ª (null) | å¤šå…¥å•å‡º |
| **Tool** | âœ… å•ä¸ª | âœ… å•ä¸ª (null) | å¤šå…¥å•å‡º |
| **ImageGen** | âœ… å•ä¸ª | âœ… å•ä¸ª (null) | å¤šå…¥å•å‡º |
| **Branch** | âœ… å•ä¸ª | âœ… åŒåˆ†æ”¯ (`"true"` / `"false"`) | æ¡ä»¶åˆ†æ”¯ï¼Œè¾“å‡ºéœ€æŒ‡å®š handle |
| **Output** | âœ… å•ä¸ª | âŒ æ—  | å·¥ä½œæµç»ˆç‚¹ï¼Œæ— ä¸‹æ¸¸èŠ‚ç‚¹ |

### 1.2 è¿æ¥è¯­æ³• (Edge JSON Schema)

```typescript
interface EdgeDefinition {
    source: string;       // æºèŠ‚ç‚¹ ID (å¿…å¡«)
    target: string;       // ç›®æ ‡èŠ‚ç‚¹ ID (å¿…å¡«)
    sourceHandle?: string | null; // è¾“å‡ºç«¯å£ ID (ä»… Branch èŠ‚ç‚¹éœ€è¦)
}
```

**Edge ç¤ºä¾‹**:
```json
// æ™®é€šèŠ‚ç‚¹è¿æ¥
{ "source": "input_1", "target": "llm_1" }

// Branch èŠ‚ç‚¹è¿æ¥ (å¿…é¡»æŒ‡å®š sourceHandle)
{ "source": "branch_1", "target": "llm_true", "sourceHandle": "true" }
{ "source": "branch_1", "target": "llm_false", "sourceHandle": "false" }
```

### 1.3 æ‹“æ‰‘çº¦æŸ (Graph Constraints)

| çº¦æŸç±»å‹ | è§„åˆ™ | è¿è§„åæœ |
|---------|------|---------|
| **è‡ªç¯ç¦æ­¢** | `source === target` æ—¶è¿æ¥è¢«æ‹’ç» | è¿æ¥æ— æ•ˆï¼Œä¸åˆ›å»º Edge |
| **å¾ªç¯ç¦æ­¢ (DAG)** | ç¦æ­¢æœ‰å‘ç¯ï¼Œä½¿ç”¨ DFS å®æ—¶æ£€æµ‹ | è¿æ¥æ— æ•ˆï¼Œä¸åˆ›å»º Edge |
| **å¼±ç±»å‹è¿æ¥** | æ— æ•°æ®ç±»å‹åŒ¹é…é™åˆ¶ | ä»»æ„è¾“å‡ºå¯è¿æ¥ä»»æ„è¾“å…¥ |

> [!CAUTION]
> **AI ç¼–æ’çº¦æŸ**: ç”Ÿæˆå·¥ä½œæµæ—¶ **å¿…é¡»ä¿è¯ DAG ç»“æ„**ï¼Œä»»ä½•å½¢æˆå¾ªç¯çš„ Edge éƒ½ä¼šè¢«ç³»ç»Ÿé™é»˜æ‹’ç»ã€‚

### 1.4 å¤šå…¥å¤šå‡ºè§„åˆ™

- **å¤šå…¥ (Multi-In)**: é™¤ Input èŠ‚ç‚¹å¤–ï¼Œæ‰€æœ‰èŠ‚ç‚¹å‡æ”¯æŒå¤šä¸ªä¸Šæ¸¸è¿æ¥
- **å¤šå‡º (Multi-Out)**: æ‰€æœ‰èŠ‚ç‚¹ï¼ˆé™¤ Outputï¼‰æ”¯æŒè¿æ¥å¤šä¸ªä¸‹æ¸¸èŠ‚ç‚¹
- **Branch ç‰¹æ®Šæ€§**: Branch æœ‰ä¸¤ä¸ªç‹¬ç«‹è¾“å‡ºç«¯å£ï¼Œæ¯ä¸ªç«¯å£å¯ç‹¬ç«‹è¿æ¥å¤šä¸ªä¸‹æ¸¸

---

## 2. æ•°æ®å¼•ç”¨è¯­æ³• (Variable Referencing Protocol)

### 2.1 å˜é‡æ ¼å¼

```
{{å˜é‡è·¯å¾„}}
```

**æ­£åˆ™è¡¨è¾¾å¼**:
```regex
/\{\{([^}]+)\}\}/g
```

### 2.2 å¼•ç”¨è·¯å¾„ç±»å‹

| æ ¼å¼ | ç¤ºä¾‹ | è¯´æ˜ | æ¨èåº¦ |
|------|------|------|--------|
| **ç›´æ¥å­—æ®µ** | `{{response}}` | ä»æ‰€æœ‰ä¸Šæ¸¸æŸ¥æ‰¾åŒ¹é…å­—æ®µ | âš ï¸ æœ‰æ­§ä¹‰é£é™© |
| **èŠ‚ç‚¹æ ‡ç­¾.å­—æ®µ** | `{{æ–‡ç« ç”Ÿæˆ.response}}` | ä½¿ç”¨èŠ‚ç‚¹ label å‰ç¼€ | âœ… æ¨è |
| **èŠ‚ç‚¹ID.å­—æ®µ** | `{{llm_abc123.response}}` | ä½¿ç”¨èŠ‚ç‚¹ ID å‰ç¼€ | âœ… ç²¾ç¡® |

### 2.3 æ·±å±‚åµŒå¥—æ”¯æŒ

```
// å¯¹è±¡åµŒå¥—
{{èŠ‚ç‚¹å.formData.å­—æ®µå}}

// æ•°ç»„ä¸‹æ ‡ (ä»… collectVariablesRaw åœºæ™¯)
{{èŠ‚ç‚¹å.files[0].url}}
```

### 2.4 ä¼˜å…ˆçº§è§„åˆ™

```
ç›´æ¥ä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡º > å…¨å±€ flowContext ä¸­çš„èŠ‚ç‚¹è¾“å‡º
```

**å…³é”®ç‚¹**:
1. åŒåå­—æ®µæ—¶ï¼Œç›´æ¥ç›¸è¿çš„ä¸Šæ¸¸èŠ‚ç‚¹ä¼˜å…ˆ
2. å˜é‡æœªæ‰¾åˆ°æ—¶æ›¿æ¢ä¸º**ç©ºå­—ç¬¦ä¸²**
3. æ§åˆ¶å°è¾“å‡ºè­¦å‘Š: `[PromptParser] æœªæ‰¾åˆ°å˜é‡: xxx`

### 2.5 å„èŠ‚ç‚¹è¾“å‡º Schema

| èŠ‚ç‚¹ç±»å‹ | è¾“å‡ºå­—æ®µ | ç±»å‹ | è¯´æ˜ |
|---------|---------|------|------|
| **Input** | `user_input` | `string` | ç”¨æˆ·è¾“å…¥æ–‡æœ¬ |
| | `files` | `array` | ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ |
| | `formData` | `object` | ç»“æ„åŒ–è¡¨å•æ•°æ® |
| **LLM** | `response` | `string` | AI ç”Ÿæˆå›å¤ |
| **RAG** | `query` | `string` | æ£€ç´¢æŸ¥è¯¢ |
| | `documents` | `array` | æ–‡æ¡£å—æ•°ç»„ |
| | `citations` | `array` | å¼•ç”¨åˆ—è¡¨ |
| **Tool** | *(å·¥å…·ç‰¹å®š)* | `any` | å¦‚ `formatted`, `results` ç­‰ |
| **Branch** | `conditionResult` | `boolean` | æ¡ä»¶åˆ¤æ–­ç»“æœ |
| | `passed` | `boolean` | åŒ conditionResult |
| | *(é€ä¼ )* | `any` | ä¸Šæ¸¸æ•°æ®é€ä¼  |
| **ImageGen** | `imageUrl` | `string` | ç”Ÿæˆå›¾ç‰‡ URL |
| **Output** | `text` | `string` | æœ€ç»ˆè¾“å‡ºæ–‡æœ¬ |
| | `attachments` | `array` | é™„ä»¶åˆ—è¡¨ |

---

## 3. æ‰§è¡Œæ—¶åºé€»è¾‘ (Execution Lifecycle)

### 3.1 æ‰§è¡Œæµç¨‹

```mermaid
flowchart TD
    A[runFlow å¼€å§‹] --> B[å¾ªç¯ä¾èµ–æ£€æµ‹]
    B -->|æœ‰å¾ªç¯| C[ä¸­æ­¢å¹¶æŠ¥é”™]
    B -->|æ— å¾ªç¯| D[Input å¿…å¡«é¡¹éªŒè¯]
    D -->|ç¼ºå¤±| E[æ‰“å¼€ InputPromptDialog]
    D -->|å®Œæ•´| F[è·å–æ‰§è¡Œé”]
    F --> G[è®¡ç®—æ‹“æ‰‘å±‚çº§]
    G --> H[æŒ‰å±‚çº§å¹¶è¡Œæ‰§è¡Œ]
    H --> I[å®Œæˆ/é”™è¯¯]
    I --> J[é‡Šæ”¾æ‰§è¡Œé”]
```

### 3.2 å¹¶è¡Œæ‰§è¡Œè§„åˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| **æ‹“æ‰‘å±‚çº§** | Level 0 = æ— ä¸Šæ¸¸èŠ‚ç‚¹ï¼ŒLevel N = max(ä¸Šæ¸¸å±‚çº§) + 1 |
| **åŒå±‚å¹¶è¡Œ** | åŒå±‚çº§èŠ‚ç‚¹ä½¿ç”¨ `Promise.allSettled` å¹¶è¡Œæ‰§è¡Œ |
| **å±‚çº§ä¸²è¡Œ** | ç­‰å¾…å½“å‰å±‚çº§å…¨éƒ¨å®Œæˆåï¼Œæ‰§è¡Œä¸‹ä¸€å±‚çº§ |
| **é”™è¯¯ä¸­æ­¢** | ä»»ä¸€èŠ‚ç‚¹å¤±è´¥ï¼Œå½“å‰å±‚çº§å®Œæˆåä¸­æ­¢åç»­æ‰§è¡Œ |

### 3.3 æ¡ä»¶åˆ†æ”¯è§¦å‘

```mermaid
graph TD
    A[Branch èŠ‚ç‚¹] -->|conditionResult=true| B[æ‰§è¡Œ TRUE è·¯å¾„ä¸‹æ¸¸]
    A -->|conditionResult=false| C[æ‰§è¡Œ FALSE è·¯å¾„ä¸‹æ¸¸]
    A -->|æœªé€‰ä¸­è·¯å¾„| D[ä¸‹æ¸¸èŠ‚ç‚¹åŠ å…¥ blockedNodes]
```

**è·¯å¾„æ±‡åˆå¤„ç†**: å¦‚æœä¸¤æ¡åˆ†æ”¯æœ€ç»ˆæ±‡åˆåˆ°åŒä¸€èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹åªè¦ä»ä»»ä¸€é€‰ä¸­è·¯å¾„å¯è¾¾ï¼Œå°±ä¼šæ‰§è¡Œã€‚

### 3.4 èµ·ç‚¹è¦æ±‚

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| **å¿…é¡»æœ‰ Input èŠ‚ç‚¹** | å·¥ä½œæµè‡³å°‘åŒ…å«ä¸€ä¸ª Input èŠ‚ç‚¹ä½œä¸ºå…¥å£ |
| **å­¤ç«‹èŠ‚ç‚¹** | æ— è¿æ¥çš„èŠ‚ç‚¹ä¼šè¢«è®¡ç®—åˆ° Level 0 å¹¶æ‰§è¡Œ |

### 3.5 è¶…æ—¶æœºåˆ¶

- **èŠ‚ç‚¹æ‰§è¡Œè¶…æ—¶**: 5 åˆ†é’Ÿ (300,000ms)
- **è¶…æ—¶åæŠ›å‡ºé”™è¯¯**: `Node execution timed out`

---

## 4. ç”»å¸ƒçŠ¶æ€ä¸æ ¡éªŒæœºåˆ¶

### 4.1 é¢„æ‰§è¡Œæ ¡éªŒ

| æ ¡éªŒé¡¹ | è§¦å‘æ—¶æœº | å¤±è´¥å¤„ç† |
|--------|---------|---------|
| å¾ªç¯ä¾èµ–æ£€æµ‹ | `runFlow` è°ƒç”¨æ—¶ | `executionError: "æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–..."` |
| Input å¿…å¡«é¡¹ | `runFlow` è°ƒç”¨æ—¶ | æ‰“å¼€ InputPromptDialog |
| æ‰§è¡Œé”å†²çª | `runFlow` è°ƒç”¨æ—¶ | Toast è­¦å‘Š + è¿”å› |
| èŠ‚ç‚¹å®Œæ•´æ€§ | æ¯å±‚æ‰§è¡Œå‰ | `Error: Flow structure changed` |

### 4.2 èŠ‚ç‚¹å‚æ•°éªŒè¯

| èŠ‚ç‚¹ç±»å‹ | éªŒè¯é¡¹ | éªŒè¯æ—¶æœº |
|---------|-------|---------|
| **LLM** | systemPrompt éç©º, temperature èŒƒå›´ | æ‰§è¡Œæ—¶ |
| **RAG** | files/fileSearchStoreName å·²é…ç½® | æ‰§è¡Œæ—¶ |
| **Output** | sources/template ä¸ mode ä¸€è‡´ | æ‰§è¡Œæ—¶ |
| **ImageGen** | prompt éç©º, é…é¢å……è¶³ | æ‰§è¡Œæ—¶ |
| **Branch** | æ¡ä»¶è¡¨è¾¾å¼åœ¨ç™½åå•å†… | æ‰§è¡Œæ—¶ (ä¸åœ¨ç™½åå•è¿”å› false) |

### 4.3 é”™è¯¯ä¼ æ’­

```typescript
// æ‰§è¡Œå¤±è´¥æ—¶
if (executionErrors.length > 0) {
    const errorMessages = executionErrors
        .map(e => `${e.nodeId}: ${e.error.message}`)
        .join('; ');
    throw new Error(`èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥: ${errorMessages}`);
}
```

- **å¤±è´¥èŠ‚ç‚¹**: `status = "error"`
- **åç»­èŠ‚ç‚¹**: ä¸å†æ‰§è¡Œ
- **æ•´ä½“çŠ¶æ€**: `executionStatus = "error"`

---

## 5. AI ç¼–æ’æœ€ä½³å®è·µ

### 5.1 åˆæ³•æ‹“æ‰‘æ„å»ºè§„åˆ™

```
âœ… DO:
- ç¡®ä¿å›¾ç»“æ„ä¸º DAG (æ— ç¯)
- ä» Input èŠ‚ç‚¹å¼€å§‹æ„å»º
- ä»¥ Output èŠ‚ç‚¹ç»“æŸ
- Branch è¾“å‡ºå¿…é¡»æŒ‡å®š sourceHandle ("true" æˆ– "false")

âŒ DON'T:
- åˆ›å»ºè‡ªç¯ (source === target)
- åˆ›å»ºå¾ªç¯ä¾èµ– (A â†’ B â†’ C â†’ A)
- Input èŠ‚ç‚¹ä½œä¸ºè¿æ¥ç›®æ ‡
- Output èŠ‚ç‚¹ä½œä¸ºè¿æ¥æº
- Branch è¿æ¥å¿˜è®° sourceHandle
```

### 5.2 å˜é‡å¼•ç”¨è§„èŒƒ

```
âœ… DO:
- ä½¿ç”¨èŠ‚ç‚¹ label å‰ç¼€: {{æ–‡ç« ç”Ÿæˆ.response}}
- ç¡®è®¤ç›®æ ‡èŠ‚ç‚¹åœ¨å½“å‰èŠ‚ç‚¹çš„ä¸Šæ¸¸
- ä½¿ç”¨èŠ‚ç‚¹å®é™…è¾“å‡ºçš„å­—æ®µå

âŒ DON'T:
- å¼•ç”¨ä¸‹æ¸¸èŠ‚ç‚¹çš„è¾“å‡º (æ‰§è¡Œæ—¶è¿˜ä¸å­˜åœ¨)
- æ‹¼å†™é”™è¯¯çš„å­—æ®µå (ä¼šè¢«æ›¿æ¢ä¸ºç©º)
- åŒåå­—æ®µæ­§ä¹‰æ—¶ä½¿ç”¨æ— å‰ç¼€å¼•ç”¨
```

### 5.3 åˆ†æ”¯è®¾è®¡è§„èŒƒ

```
âœ… DO:
- ä½¿ç”¨æ”¯æŒçš„æ¡ä»¶è¡¨è¾¾å¼æ ¼å¼
- ç¡®ä¿ä¸¤æ¡åˆ†æ”¯éƒ½æœ‰æœ‰æ•ˆä¸‹æ¸¸ (æˆ–æ˜¾å¼ç»ˆæ­¢)
- æ±‡åˆç‚¹èŠ‚ç‚¹å…·å¤‡å¤„ç†ç©ºä¸Šæ¸¸çš„èƒ½åŠ›

âŒ DON'T:
- ä½¿ç”¨ä¸æ”¯æŒçš„ JavaScript è¡¨è¾¾å¼
- åˆ›å»ºæ­»å¾ªç¯åˆ†æ”¯ (Branch â†’ ... â†’ Branch)
```

### 5.4 æ¨èæ‹“æ‰‘æ¨¡å¼

**çº¿æ€§æµç¨‹**:
```
Input â†’ LLM â†’ Output
```

**å¹¶è¡Œå¤„ç†**:
```
Input â†’ LLM1 â”€â”¬â†’ Output (merge mode)
      â†’ LLM2 â”€â”˜
```

**æ¡ä»¶åˆ†æ”¯**:
```
Input â†’ Branch â”€trueâ”€â”€â†’ LLM1 â”€â”¬â†’ Output
               â”€falseâ”€â†’ LLM2 â”€â”˜
```

**RAG å¢å¼º**:
```
Input â†’ RAG â†’ LLM â†’ Output
```

---

## 6. TypeScript ç±»å‹å£°æ˜

```typescript
// === æ ¸å¿ƒèŠ‚ç‚¹ç±»å‹ ===
type NodeKind = 'input' | 'llm' | 'rag' | 'tool' | 'branch' | 'imagegen' | 'output';

// === Edge å®šä¹‰ ===
interface AppEdge {
    id: string;
    source: string;
    target: string;
    sourceHandle?: 'true' | 'false' | null; // ä»… Branch èŠ‚ç‚¹ä½¿ç”¨
    targetHandle?: string | null;
}

// === FlowContext ç»“æ„ ===
interface FlowContext {
    [nodeId: string]: Record<string, unknown> | FlowContextMeta | undefined;
    _meta?: FlowContextMeta;
}

interface FlowContextMeta {
    flowId?: string | null;
    sessionId?: string;
    nodeLabels?: Record<string, string>; // nodeId â†’ label
}

// === å˜é‡å¼•ç”¨è§£æ ===
// æ­£åˆ™: /\{\{([^}]+)\}\}/g
// åŒ¹é…: {{å˜é‡å}} æˆ– {{èŠ‚ç‚¹å.å­—æ®µå}}

// === èŠ‚ç‚¹è¾“å‡ºç±»å‹ ===
interface InputNodeOutput {
    user_input: string;
    files: FileData[];
    formData: Record<string, unknown>;
}

interface LLMNodeOutput {
    response: string;
}

interface RAGNodeOutput {
    query: string;
    documents: DocumentChunk[];
    citations: Citation[];
    documentCount: number;
    mode: 'fileSearch' | 'multimodal';
}

interface BranchNodeOutput {
    conditionResult: boolean;
    passed: boolean;
    value: unknown;
    // + ä¸Šæ¸¸æ•°æ®é€ä¼ 
    [key: string]: unknown;
}

interface ImageGenNodeOutput {
    imageUrl: string;
}

interface OutputNodeOutput {
    text: string;
    attachments: AttachmentData[];
}
```

---

## 7. æ ¸å¿ƒä»£ç æ–‡ä»¶ç´¢å¼•

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ |
|------|---------|------|
| **è¿æ¥æ ¡éªŒ** | [edgeActions.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/actions/edgeActions.ts) | `onConnect` é’©å­ï¼Œè‡ªç¯/å¾ªç¯æ£€æµ‹ |
| **å¾ªç¯æ£€æµ‹** | [cycleDetection.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/utils/cycleDetection.ts) | DFS ç®—æ³•å®ç° |
| **å¹¶è¡Œæ‰§è¡Œ** | [parallelExecutionUtils.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/utils/parallelExecutionUtils.ts) | æ‹“æ‰‘å±‚çº§è®¡ç®—ï¼Œåˆ†æ”¯é˜»å¡ |
| **æ‰§è¡Œå¼•æ“** | [executionActions.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/actions/executionActions.ts) | `runFlow` ä¸»å…¥å£ |
| **å˜é‡æ”¶é›†** | [variableUtils.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/executors/utils/variableUtils.ts) | `collectVariables` å‡½æ•° |
| **å˜é‡æ›¿æ¢** | [promptParser.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/lib/promptParser.ts) | `replaceVariables` å‡½æ•° |
| **Handle æ¸²æŸ“** | [CustomNode.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/components/flow/CustomNode.tsx) | èŠ‚ç‚¹ç«¯å£ UI |
| **è¾“å…¥éªŒè¯** | [inputValidation.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/store/utils/inputValidation.ts) | Input å¿…å¡«é¡¹æ£€æŸ¥ |

---

## 8. æ–‡æ¡ˆä¼˜åŒ–å¯¹æ¯”æ¸…å•ï¼ˆå«ç†ç”±ï¼‰

è¯´æ˜ï¼šæœ¬æ¸…å•èšç„¦â€œå½±å“ç”¨æˆ·ç†è§£ä¸æ“ä½œæ•ˆç‡â€çš„é«˜é¢‘å…¥å£æ–‡æ¡ˆï¼ˆçŠ¶æ€ã€è¿è¡Œã€é™çº§æç¤ºã€æœç´¢ä¸åŠ è½½ï¼‰ã€‚å…¶ä½™èŠ‚ç‚¹é…ç½®æ–‡æ¡ˆçš„é€é¡¹ä¼˜åŒ–ä»¥ä»£ç æäº¤ä¸ºå‡†ã€‚

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | ä¿®æ”¹ç†ç”± | ä½ç½® |
|---|---|---|---|---|
| è§„åˆ’å¤±è´¥é™çº§æç¤º | æ–¹æ¡ˆæ•´ç†æ²¡æœ‰æˆåŠŸï¼Œæˆ‘ä¼šç›´æ¥ç”Ÿæˆå·¥ä½œæµï¼ˆä½ å¯ä»¥ç¨åå†è°ƒæ•´ï¼‰ã€‚ | è§„åˆ’é˜¶æ®µæœªäº§å‡ºæœ‰æ•ˆè®¡åˆ’ï¼Œæˆ‘ä¼šç›´æ¥ç”Ÿæˆå·¥ä½œæµï¼ˆä½ å¯ä»¥ç¨åå†è°ƒæ•´ï¼‰ã€‚ | æ˜ç¡®å¤±è´¥å‘ç”Ÿåœ¨â€œè§„åˆ’é˜¶æ®µâ€ï¼Œå‡å°‘ä¸»è§‚æªè¾ï¼›ä¸æµ‹è¯•æ–­è¨€ä¿æŒä¸€è‡´ | [route.ts](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/app/api/agent/plan/route.ts#L690-L697) |
| èŠ‚ç‚¹è¿è¡Œ Tooltip | æ­£åœ¨è¿è¡Œâ€¦ / è¿è¡Œè¯¥èŠ‚ç‚¹ | è¿è¡Œä¸­â€¦ / è¿è¡Œæ­¤èŠ‚ç‚¹ | â€œè¿è¡Œä¸­â€ä¸çŠ¶æ€æ å£å¾„ä¸€è‡´ï¼›â€œæ­¤èŠ‚ç‚¹â€æŒ‡ä»£æ›´è‡ªç„¶ | [context-hud/index.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/components/builder/context-hud/index.tsx#L340-L367) |
| å•èŠ‚ç‚¹è°ƒè¯•å…¥å£ | è¿è¡Œä¸­... / æµ‹è¯• | è¿è¡Œä¸­â€¦ / è¯•è¿è¡Œ | ç»Ÿä¸€çœç•¥å·é£æ ¼ï¼›â€œè¯•è¿è¡Œâ€é¿å…ä¸æµ‹è¯•ä½“ç³»æ··æ·† | [CustomNode.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/components/flow/CustomNode.tsx#L195-L218) |
| å·¥å…·èŠ‚ç‚¹è°ƒè¯•å…¥å£ | è¿è¡Œä¸­... / æµ‹è¯• | è¿è¡Œä¸­â€¦ / è¯•è¿è¡Œ | åŒä¸Šï¼Œä¿è¯ä¸åŒèŠ‚ç‚¹ç»„ä»¶è¡¨è¾¾ä¸€è‡´ | [ToolNode.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/components/flow/nodes/ToolNode.tsx#L69-L91) |
| æ™ºèƒ½ä½“åˆ—è¡¨æœç´¢ | æŸ¥æ‰¾æˆ‘çš„æ™ºèƒ½ä½“... | æŸ¥æ‰¾æˆ‘çš„æ™ºèƒ½ä½“â€¦ | ç»Ÿä¸€çœç•¥å·é£æ ¼ï¼Œé™ä½â€œä¸åŒé¡µé¢ä¸åŒå†™æ³•â€çš„å­¦ä¹ æˆæœ¬ | [flows/page.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/app/flows/page.tsx#L97-L114) |
| åˆ›å»ºæŒ‰é’®çŠ¶æ€ | åˆ›å»ºä¸­... | åˆ›å»ºä¸­â€¦ | åŒä¸Š | [flows/page.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/app/flows/page.tsx#L107-L110) |
| åˆ—è¡¨åŠ è½½çŠ¶æ€ | åŠ è½½ä¸­... | åŠ è½½ä¸­â€¦ | åŒä¸Š | [flows/page.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/app/flows/page.tsx#L132-L139) |
| åº”ç”¨é¡µåŠ è½½çŠ¶æ€ | åŠ è½½ä¸­... | åŠ è½½ä¸­â€¦ | åŒä¸Š | [app/page.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/app/app/page.tsx#L201-L208) |
| ä¾§è¾¹æ åŠ è½½çŠ¶æ€ | åŠ è½½ä¸­... | åŠ è½½ä¸­â€¦ | åŒä¸Š | [home-sidebar.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/components/sidebar/home-sidebar.tsx#L170-L186) |
| æ¨¡å‹åå ä½ | åŠ è½½ä¸­... | åŠ è½½ä¸­â€¦ | åŒä¸Š | [LLMMetadata.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/components/flow/nodes/metadata/LLMMetadata.tsx#L45-L51) |
| ä¸Šä¼ æŒ‰é’®çŠ¶æ€ | ä¸Šä¼ ä¸­... | ä¸Šä¼ ä¸­â€¦ | åŒä¸Š | [CodeInterpreterFileUpload.tsx](file:///Users/jasperlin/Desktop/product/flash-flow-saas/flash-flow/src/components/flow/tool-inputs/CodeInterpreterFileUpload.tsx#L99-L110) |

---

## 9. ä¼˜åŒ–æ–‡æ¡ˆåº“ä¸ä½¿ç”¨è§„èŒƒï¼ˆMVPï¼‰

### 9.1 çŠ¶æ€æ–‡æ¡ˆï¼ˆç»Ÿä¸€å£å¾„ï¼‰

| çŠ¶æ€ç±»å‹ | æ–‡æ¡ˆ |
|---|---|
| Loading | åŠ è½½ä¸­â€¦ |
| Uploading | ä¸Šä¼ ä¸­â€¦ |
| Running | è¿è¡Œä¸­â€¦ |
| Creating | åˆ›å»ºä¸­â€¦ |
| Ready | å°±ç»ª |
| Success | æˆåŠŸ |
| Error | é”™è¯¯ |

### 9.2 è¡ŒåŠ¨æ–‡æ¡ˆï¼ˆæŒ‰é’®/å…¥å£ï¼‰

| ç›®æ ‡ | Buttonï¼ˆçŸ­ï¼‰ | Tooltipï¼ˆæ˜ç¡®å¯¹è±¡ï¼‰ |
|---|---|---|
| è¿è¡Œå½“å‰èŠ‚ç‚¹ | è¿è¡Œ | è¿è¡Œæ­¤èŠ‚ç‚¹ |
| è°ƒè¯•è¿è¡Œå•èŠ‚ç‚¹ | è¯•è¿è¡Œ | è¯•è¿è¡Œ |
| é‡è¯• | é‡è¯• | é‡è¯• |
| æ¸…ç†ç­›é€‰/æœç´¢ | æ¸…é™¤æœç´¢ | æ¸…é™¤æœç´¢ |

### 9.3 å…³é”®æç¤ºæ–‡æ¡ˆï¼ˆè§£é‡Šç³»ç»Ÿè¡Œä¸ºï¼‰

| åœºæ™¯ | æ¨èæ–‡æ¡ˆ | ä½¿ç”¨è¯´æ˜ |
|---|---|---|
| è§„åˆ’é™çº§ | è§„åˆ’é˜¶æ®µæœªäº§å‡ºæœ‰æ•ˆè®¡åˆ’ï¼Œæˆ‘ä¼šç›´æ¥ç”Ÿæˆå·¥ä½œæµï¼ˆä½ å¯ä»¥ç¨åå†è°ƒæ•´ï¼‰ã€‚ | ä»…åœ¨â€œä»è§„åˆ’æ¨¡å¼é™çº§åˆ°ç›´å‡ºæ¨¡å¼â€æ—¶å‡ºç° |
| è¾“å…¥ç¼ºå¤± | ä¿¡æ¯æœªå¡«å†™å®Œæ•´ï¼Œè¯·è¡¥å……åå†è¿è¡Œã€‚ | ç”¨äºè¡¨å•æ ¡éªŒï¼Œä¸æè¿°å†…éƒ¨å­—æ®µå |
| ç½‘ç»œå¼‚å¸¸ | ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚ | æ— æ³•åŒºåˆ†æœåŠ¡ç«¯/å®¢æˆ·ç«¯æ—¶çš„ä¿åº•æç¤º |

### 9.4 è½åœ°æ–¹å¼ï¼ˆé¿å…å†æ¬¡åˆ†è£‚ï¼‰

- æ–°å¢æˆ–æ”¹åŠ¨ç”¨æˆ·å¯è§æ–‡æ¡ˆæ—¶ï¼Œä¼˜å…ˆå¤ç”¨ç¬¬ 9 èŠ‚çš„â€œçŠ¶æ€/è¡ŒåŠ¨/æç¤ºâ€æ ‡å‡†å£å¾„ã€‚
- åŒä¸€æ¦‚å¿µåªä¿ç•™ä¸€ä¸ªä¸»ç§°å‘¼ï¼ˆè§ç¬¬ 0.4 èŠ‚æœ¯è¯­è¡¨ï¼‰ï¼Œå…¶ä»–ç§°å‘¼ä½œä¸ºâ€œå†…éƒ¨å­—æ®µåâ€ä¸æš´éœ²ç»™ç”¨æˆ·ã€‚
- åŒç±»ç»„ä»¶è‹¥å­˜åœ¨å¤šå¤„å…¥å£ï¼ˆå¦‚èŠ‚ç‚¹å¡ç‰‡ã€é…ç½®é¢æ¿ã€Tooltipï¼‰ï¼Œä»¥â€œä¸»å…¥å£è¯â€ç»Ÿä¸€ï¼ˆButton çŸ­ã€Tooltip æ˜ç¡®å¯¹è±¡ï¼‰ã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0 | ç”Ÿæˆæ—¥æœŸ: 2026-01-06 | åŸºäºä»£ç å®¡è®¡*
