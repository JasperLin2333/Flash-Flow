## 4️⃣ Output 节点（输出节点）

### 功能描述
工作流的**最终出口**，如果不连接 Output 节点，工作流执行完成后可能无法在前端正确显示结果。
Output 节点负责收集上游节点的执行结果，并根据配置的**输出模式**（direct/select/merge/template）对内容进行处理，最终将**文本**回复和**附件**文件返回给用户。

### 核心参数

| 参数名 | 类型 | 必填 | 默认值 | 描述 |
|-------|------|-----|-------|------|
| `label` | string | ✅ | - | 节点显示名称 |
| `inputMappings.mode` | string | ❌ | `"direct"` | 输出内容的处理模式 (见下文) |
| `inputMappings.sources` | object[] | ❌ | `[]` | 内容来源列表 (direct/select/merge 模式使用) |
| `inputMappings.template` | string | ❌ | `""` | 模板内容 (template 模式使用) |
| `inputMappings.attachments` | object[] | ❌ | `[]` | 附件来源列表 |

> [!TIP]
> 变量引用不仅支持 **节点名称** (如 `{{LLM Node.response}}`)，也支持 **节点 ID** (如 `{{node-12345.response}}`)。

### 输出模式 (Output Modes)

Output 节点支持四种模式，适用于不同的场景：

| 模式 | 标识 (`mode`) | 描述 | 配置项 | 适用场景 |
|-----|--------------|------|-------|---------| 
| **直接引用** | `direct` | 直接输出单一来源的内容。 | `sources` (仅限1个) | 简单流程，直接透传 LLM 回复。 |
| **分支选择** | `select` | 按顺序检查来源，输出**第一个非空且已解析**的结果(跳过含 `{{}}` 的值)。 | `sources` (多个，按优先级排序) | 分支流程 (Branch)，不同路径产生不同结果。 |
| **内容合并** | `merge` | 将所有**非空且已解析**的来源内容**拼接**在一起（双换行分隔）。 | `sources` (多个，按合并顺序) |多步骤生成内容，需要汇总输出。 |
| **模板渲染** | `template` | 使用自定义模板，将变量嵌入固定文本格式中。 | `template` (支持 {{变量}} 语法) | 格式化报告、标准化回复。 |

### 流式输出行为 (Streaming Behavior)

Output 节点的模式会影响上游 LLM 节点的流式输出策略：

| Output 模式 | 是否流式 | 流式模式 | 行为描述 |
|-------------|---------|---------|---------|
| **direct** | ✅ | `single` | 只有第一个配置的 source 启用流式 |
| **select** | ✅ | `select` | **首字锁定机制**：多个 LLM 竞速，第一个输出字符的节点锁定通道 |
| **merge** | ✅ | `segmented` | **分段流式**：每个 source 独立输出到对应段落 |
| **template** | ❌ | - | 需等待完整结果进行模板渲染，不流式 |

### 附件配置 (Attachments)

Output 节点均支持返回文件附件（如生成的文档、图表等）。
在配置面板底部的"附件 (可选)"区域添加来源。

- **支持类型**:
  - **文件数组**: 如 `{{用户输入.files}}` (透传用户上传的文件)
  - **单文件对象**: 如 `{{代码执行.generatedFile}}` (返回代码生成的单个文件)

### 配置示例

#### 1. 简单透传 LLM 回复
- **模式**: `direct`
- **来源 1**: `{{LLM处理.response}}`

#### 2. 分支兜底输出
- **模式**: `select`
- **来源 1**: `{{分支A.result}}` (如果分支A执行了)
- **来源 2**: `{{分支B.result}}` (如果分支B执行了)
- **来源 3**: `{{默认回复.text}}` (兜底)

#### 3. 生成带图表的分析报告
- **模式**: `template`
- **模板内容**:
  ```markdown
  ## 数据分析报告
  
  {{LLM分析.summary}}
  
  ### 关键指标
  {{代码计算.metrics}}
  ```
- **附件来源**:
  - `{{代码绘图.generatedFile}}` (生成的图表图片)

### 输出格式 (JSON Structure)

Output 节点的执行结果是标准化的结构，Chat 界面会解析此结构进行展示：

```typescript
{
  "text": string,                             // 最终处理后的文本内容
  
  // 仅在配置了有效附件时存在
  "attachments"?: [
    {
      "name": string,                         // 文件名
      "url": string,                          // 文件下载/访问链接
      "type"?: string                         // MIME类型 (可选)
    }
  ]
}
```

> [!NOTE]
> Chat 界面会自动识别 `attachments` 字段并在气泡下方渲染为可点击的文件卡片。
> 如果没有 Output 节点，系统会尝试自动提取上游最后一个节点的文本内容，但**无法显示附件**。